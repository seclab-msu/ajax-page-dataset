!function(e,t){"function"==typeof define&&define.amd?define(["exports","backbone","underscore"],t):"undefined"!=typeof exports?t(exports,require("backbone"),require("underscore")):t(e,e.Backbone,e._)}(this,function(e,c,h){"use strict";c.Relational={showWarnings:!0},c.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw new Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw new Error("All permits released");this._permitsUsed--},isLocked:function(){return 0<this._permitsUsed},setAvailablePermits:function(e){if(this._permitsUsed>e)throw new Error("Available permits cannot be less than used permits");this._permitsAvailable=e}},c.BlockingQueue=function(){this._queue=[]},h.extend(c.BlockingQueue.prototype,c.Semaphore,{_queue:null,add:function(e){this.isBlocked()?this._queue.push(e):e()},process:function(){var e=this._queue;for(this._queue=[];e&&e.length;)e.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),c.Relational.eventQueue=new c.BlockingQueue,c.Store=function(){this._collections=[],this._reverseRelations=[],this._orphanRelations=[],this._subModels=[],this._modelScopes=[e]},h.extend(c.Store.prototype,c.Events,{initializeRelation:function(e,t,i){var o=h.isString(t.type)?c[t.type]||this.getObjectByName(t.type):t.type;o&&o.prototype instanceof c.Relation?new o(e,t,i):c.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid relation type!",t)},addModelScope:function(e){this._modelScopes.push(e)},removeModelScope:function(e){this._modelScopes=h.without(this._modelScopes,e)},addSubModels:function(e,t){this._subModels.push({superModelType:t,subModels:e})},setupSuperModel:function(o){h.find(this._subModels,function(i){return h.filter(i.subModels||[],function(e,t){e=this.getObjectByName(e);if(o===e)return(i.superModelType._subModels[t]=o)._superModel=i.superModelType,o._subModelTypeValue=t,o._subModelTypeAttribute=i.superModelType.prototype.subModelTypeAttribute,!0},this).length},this)},addReverseRelation:function(e){!h.any(this._reverseRelations,function(i){return h.all(e||[],function(e,t){return e===i[t]})})&&e.model&&e.type&&(this._reverseRelations.push(e),this._addRelation(e.model,e),this.retroFitRelation(e))},addOrphanRelation:function(e){!h.any(this._orphanRelations,function(i){return h.all(e||[],function(e,t){return e===i[t]})})&&e.model&&e.type&&this._orphanRelations.push(e)},processOrphanRelations:function(){h.each(this._orphanRelations.slice(0),function(e){c.Relational.store.getObjectByName(e.relatedModel)&&(this.initializeRelation(null,e),this._orphanRelations=h.without(this._orphanRelations,e))},this)},_addRelation:function(e,t){e.prototype.relations||(e.prototype.relations=[]),e.prototype.relations.push(t),h.each(e._subModels||[],function(e){this._addRelation(e,t)},this)},retroFitRelation:function(t){var e=this.getCollection(t.model,!1);e&&e.each(function(e){e instanceof t.model&&new t.type(e,t)},this)},getCollection:function(e,t){for(var i=e=e instanceof c.RelationalModel?e.constructor:e;i._superModel;)i=i._superModel;e=h.find(this._collections,function(e){return e.model===i});return e=e||!1===t?e:this._createCollection(i)},getObjectByName:function(e){var t=e.split("."),i=null;return h.find(this._modelScopes,function(e){if((i=h.reduce(t||[],function(e,t){return e?e[t]:void 0},e))&&i!==e)return!0},this),i},_createCollection:function(e){var t;return(e=e instanceof c.RelationalModel?e.constructor:e).prototype instanceof c.RelationalModel&&((t=new c.Collection).model=e,this._collections.push(t)),t},resolveIdForItem:function(e,t){var i=h.isString(t)||h.isNumber(t)?t:null;return null===i&&(t instanceof c.RelationalModel?i=t.id:h.isObject(t)&&(i=t[e.prototype.idAttribute])),i=i||0===i?i:null},find:function(e,t){var t=this.resolveIdForItem(e,t),i=this.getCollection(e);if(i){i=i.get(t);if(i instanceof e)return i}return null},register:function(e){var t,i=this.getCollection(e);i&&(t=e.collection,i.add(e),e.collection=t)},checkId:function(e,t){var i=this.getCollection(e),i=i&&i.get(t);if(i&&e!==i)throw c.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",i,e),new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")},update:function(e){var t=this.getCollection(e);t.contains(e)||this.register(e),t._onModelEvent("change:"+e.idAttribute,e,t),e.trigger("relational:change:id",e,t)},unregister:function(e){var t,i=e instanceof c.Model?(t=this.getCollection(e),[e]):e instanceof c.Collection?(t=this.getCollection(e.model),h.clone(e.models)):(t=this.getCollection(e),h.clone(t.models));h.each(i,function(e){this.stopListening(e),h.invoke(e.getRelations(),"stopListening")},this),h.contains(this._collections,e)?t.reset([]):h.each(i,function(e){t.get(e)?t.remove(e):t.trigger("relational:remove",e,t)},this)},reset:function(){this.stopListening(),h.each(this._collections,function(e){this.unregister(e)},this),this._collections=[],this._subModels=[],this._modelScopes=[e]}}),c.Relational.store=new c.Store,c.Relation=function(e,t,i){this.instance=e,t=h.isObject(t)?t:{},this.reverseRelation=h.defaults(t.reverseRelation||{},this.options.reverseRelation),this.options=h.defaults(t,this.options,c.Relation.prototype.options),this.reverseRelation.type=h.isString(this.reverseRelation.type)?c[this.reverseRelation.type]||c.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.model=this.options.model||this.instance.constructor,this.relatedModel=this.options.relatedModel,!h.isFunction(this.relatedModel)||this.relatedModel.prototype instanceof c.RelationalModel||(this.relatedModel=h.result(this,"relatedModel")),h.isString(this.relatedModel)&&(this.relatedModel=c.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()&&(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&c.Relational.store.addReverseRelation(h.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),e&&((t=this.keySource)!==this.key&&"object"==typeof this.instance.get(this.key)&&(t=this.key),this.setKeyContents(this.instance.get(t)),this.relatedCollection=c.Relational.store.getCollection(this.relatedModel),this.keySource!==this.key&&delete this.instance.attributes[this.keySource],(this.instance._relations[this.key]=this).initialize(i),this.options.autoFetch&&this.instance.fetchRelated(this.key,h.isObject(this.options.autoFetch)?this.options.autoFetch:{}),this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)))},c.Relation.extend=c.Model.extend,h.extend(c.Relation.prototype,c.Events,c.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1,autoFetch:!1,parse:!1},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var e=this.instance,t=this.key,i=this.model,o=this.relatedModel,n=c.Relational.showWarnings&&"undefined"!=typeof console;if(!i||!t||!o)return n&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,i,t,o),!1;if(!(i.prototype instanceof c.RelationalModel))return n&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,e),!1;if(!(o.prototype instanceof c.RelationalModel))return n&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,o),!1;if(this instanceof c.HasMany&&this.reverseRelation.type===c.HasMany)return n&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(e&&h.keys(e._relations).length){i=h.find(e._relations,function(e){return e.key===t},this);if(i)return n&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,t,e,i),!1}return!0},setRelated:function(e){this.related=e,this.instance.attributes[this.key]=e},_isReverseRelation:function(e){return e.instance instanceof this.relatedModel&&this.reverseRelation.key===e.key&&this.key===e.reverseRelation.key},getReverseRelations:function(e){var t=[],e=h.isUndefined(e)?this.related&&(this.related.models||[this.related]):[e];return h.each(e||[],function(e){h.each(e.getRelations()||[],function(e){this._isReverseRelation(e)&&t.push(e)},this)},this),t},destroy:function(){this.stopListening(),this instanceof c.HasOne?this.setRelated(null):this instanceof c.HasMany&&this.setRelated(this._prepareCollection()),h.each(this.getReverseRelations(),function(e){e.removeRelated(this.instance)},this)}}),c.HasOne=c.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(t){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var e=this.findRelated(t);this.setRelated(e),h.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,t)},this)},findRelated:function(e){var t=null;return e=h.defaults({parse:this.options.parse},e),this.keyContents instanceof this.relatedModel?t=this.keyContents:!this.keyContents&&0!==this.keyContents||(e=h.defaults({create:this.options.createModels},e),t=this.relatedModel.findOrCreate(this.keyContents,e)),t&&(this.keyId=null),t},setKeyContents:function(e){this.keyContents=e,this.keyId=c.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(e,t,i){var o,n,s;this.isLocked()||(this.acquire(),i=i?h.clone(i):{},o=(n=h.isUndefined(i.__related))?this.related:i.__related,n&&(this.setKeyContents(t),n=this.findRelated(i),this.setRelated(n)),o&&this.related!==o&&h.each(this.getReverseRelations(o),function(e){e.removeRelated(this.instance,null,i)},this),h.each(this.getReverseRelations(),function(e){e.addRelated(this.instance,i)},this),i.silent||this.related===o||((s=this).changed=!0,c.Relational.eventQueue.add(function(){s.instance.trigger("change:"+s.key,s.instance,s.related,i,!0),s.changed=!1})),this.release())},tryAddRelated:function(e,t,i){!this.keyId&&0!==this.keyId||e.id!==this.keyId||(this.addRelated(e,i),this.keyId=null)},addRelated:function(t,i){var o=this;t.queue(function(){var e;t!==o.related&&(e=o.related||null,o.setRelated(t),o.onChange(o.instance,t,h.defaults({__related:e},i)))})},removeRelated:function(e,t,i){var o;this.related&&e===this.related&&(o=this.related||null,this.setRelated(null),this.onChange(this.instance,e,h.defaults({__related:o},i)))}}),c.HasMany=c.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:c.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(e){if(this.listenTo(this.instance,"relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,!h.isFunction(this.collectionType)||this.collectionType===c.Collection||this.collectionType.prototype instanceof c.Collection||(this.collectionType=h.result(this,"collectionType")),h.isString(this.collectionType)&&(this.collectionType=c.Relational.store.getObjectByName(this.collectionType)),this.collectionType!==c.Collection&&!(this.collectionType.prototype instanceof c.Collection))throw new Error("`collectionType` must inherit from Backbone.Collection");e=this.findRelated(e);this.setRelated(e)},_prepareCollection:function(e){var t;return this.related&&this.stopListening(this.related),e&&e instanceof c.Collection||(t=h.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions,e=new this.collectionType(null,t)),e.model=this.relatedModel,this.options.collectionKey&&(e[t=!0===this.options.collectionKey?this.options.reverseRelation.key:this.options.collectionKey]&&e[t]!==this.instance?c.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,t,this.options.collectionKey):t&&(e[t]=this.instance)),this.listenTo(e,"relational:add",this.handleAddition).listenTo(e,"relational:remove",this.handleRemoval).listenTo(e,"relational:reset",this.handleReset),e},findRelated:function(t){var i,e=null;return t=h.defaults({parse:this.options.parse},t),this.keyContents instanceof c.Collection?(this._prepareCollection(this.keyContents),e=this.keyContents):(i=[],h.each(this.keyContents,function(e){e=e instanceof this.relatedModel?e:this.relatedModel.findOrCreate(e,h.extend({merge:!0},t,{create:this.options.createModels}));e&&i.push(e)},this),(e=this.related instanceof c.Collection?this.related:this._prepareCollection()).set(i,h.defaults({merge:!1,parse:!1},t))),this.keyIds=h.difference(this.keyIds,h.pluck(e.models,"id")),e},setKeyContents:function(e){this.keyContents=e instanceof c.Collection?e:null,this.keyIds=[],this.keyContents||!e&&0!==e||(this.keyContents=h.isArray(e)?e:[e],h.each(this.keyContents,function(e){e=c.Relational.store.resolveIdForItem(this.relatedModel,e);!e&&0!==e||this.keyIds.push(e)},this))},onChange:function(e,t,i){i=i?h.clone(i):{},this.setKeyContents(t),this.changed=!1;var o,t=this.findRelated(i);this.setRelated(t),i.silent||(o=this,c.Relational.eventQueue.add(function(){o.changed&&(o.instance.trigger("change:"+o.key,o.instance,o.related,i,!0),o.changed=!1)}))},handleAddition:function(e,t,i){i=i?h.clone(i):{},this.changed=!0,h.each(this.getReverseRelations(e),function(e){e.addRelated(this.instance,i)},this);var o=this;i.silent||c.Relational.eventQueue.add(function(){o.instance.trigger("add:"+o.key,e,o.related,i)})},handleRemoval:function(e,t,i){i=i?h.clone(i):{},this.changed=!0,h.each(this.getReverseRelations(e),function(e){e.removeRelated(this.instance,null,i)},this);var o=this;i.silent||c.Relational.eventQueue.add(function(){o.instance.trigger("remove:"+o.key,e,o.related,i)})},handleReset:function(e,t){var i=this;(t=t?h.clone(t):{}).silent||c.Relational.eventQueue.add(function(){i.instance.trigger("reset:"+i.key,i.related,t)})},tryAddRelated:function(e,t,i){h.contains(this.keyIds,e.id)&&(this.addRelated(e,i),this.keyIds=h.without(this.keyIds,e.id))},addRelated:function(e,t){var i=this;e.queue(function(){i.related&&!i.related.get(e)&&i.related.add(e,h.defaults({parse:!1},t))})},removeRelated:function(e,t,i){this.related.get(e)&&this.related.remove(e,i)}}),c.RelationalModel=c.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,_attributeChangeFired:!1,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(e,t){var i,o,n;t&&t.collection&&(o=(i=this).collection=t.collection,delete t.collection,this._deferProcessing=!0,o.on("relational:add",n=function(e){e===i&&(i._deferProcessing=!1,i.processQueue(),o.off("relational:add",n))}),h.defer(function(){n(i)})),c.Relational.store.processOrphanRelations(),c.Relational.store.listenTo(this,"relational:unregister",c.Relational.store.unregister),this._queue=new c.BlockingQueue,this._queue.block(),c.Relational.eventQueue.block();try{c.Model.apply(this,arguments)}finally{c.Relational.eventQueue.unblock()}},trigger:function(o){var n,s;return 5<o.length&&0===o.indexOf("change")?(n=this,s=arguments,c.Relational.eventQueue.isLocked()?c.Relational.eventQueue.add(function(){var e,t,i=!0;"change"===o?(i=n.hasChanged()||n._attributeChangeFired,n._attributeChangeFired=!1):(e=o.slice(7),(t=n.getRelation(e))?(i=!0===s[4])?n.changed[e]=s[2]:t.changed||delete n.changed[e]:i&&(n._attributeChangeFired=!0)),i&&c.Model.prototype.trigger.apply(n,s)}):c.Model.prototype.trigger.apply(n,s)):"destroy"===o?(c.Model.prototype.trigger.apply(this,arguments),c.Relational.store.unregister(this)):c.Model.prototype.trigger.apply(this,arguments),this},initializeRelations:function(t){this.acquire(),this._relations={},h.each(this.relations||[],function(e){c.Relational.store.initializeRelation(this,e,t)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(o,n){this._isInitialized&&!this.isLocked()&&h.each(this._relations,function(e){var t,i;(!o||e.keySource in o||e.key in o)&&(t=this.attributes[e.keySource]||this.attributes[e.key],i=o&&(o[e.keySource]||o[e.key]),(e.related!==t||null===t&&null===i)&&this.trigger("relational:change:"+e.key,this,t,n||{})),e.keySource!==e.key&&delete this.attributes[e.keySource]},this)},queue:function(e){this._queue.add(e)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(e){return this._relations[e]},getRelations:function(){return h.values(this._relations)},fetchRelated:function(e,o,t){o=h.extend({update:!0,remove:!1},o);var i,n,s,l=[],r=this.getRelation(e),a=r&&(r.keyIds&&r.keyIds.slice(0)||(r.keyId||0===r.keyId?[r.keyId]:[]));return t&&(s=r.related instanceof c.Collection?r.related.models:[r.related],h.each(s,function(e){!e.id&&0!==e.id||a.push(e.id)})),a&&a.length&&(n=[],s=h.map(a,function(e){var t,i=r.relatedModel.findModel(e);return i||((t={})[r.relatedModel.prototype.idAttribute]=e,i=r.relatedModel.findOrCreate(t,o),n.push(i)),i},this),l=(i=r.related instanceof c.Collection&&h.isFunction(r.related.url)?r.related.url(s):i)&&i!==r.related.url()?(e=h.defaults({error:function(){var t=arguments;h.each(n,function(e){e.trigger("destroy",e,e.collection,o),o.error&&o.error.apply(e,t)})},url:i},o),[r.related.fetch(e)]):h.map(s,function(e){var t=h.defaults({error:function(){h.contains(n,e)&&(e.trigger("destroy",e,e.collection,o),o.error&&o.error.apply(e,arguments))}},o);return e.fetch(t)},this)),l},get:function(e){var t=c.Model.prototype.get.call(this,e);if(!this.dotNotation||-1===e.indexOf("."))return t;var i=e.split("."),i=h.reduce(i,function(e,t){if(!h.isNull(e)&&!h.isUndefined(e)){if(e instanceof c.Model)return c.Model.prototype.get.call(e,t);if(e instanceof c.Collection)return c.Collection.prototype.at.call(e,t);throw new Error("Attribute must be an instanceof Backbone.Model or Backbone.Collection. Is: "+e+", currentSplit: "+t)}},this);if(void 0!==t&&void 0!==i)throw new Error("Ambiguous result for '"+e+"'. direct result: "+t+", dotNotation: "+i);return t||i},set:function(e,t,i){var o;c.Relational.eventQueue.block(),h.isObject(e)||null==e?(o=e,i=t):(o={})[e]=t;try{var n=this.id,s=o&&this.idAttribute in o&&o[this.idAttribute],l=(c.Relational.store.checkId(this,s),c.Model.prototype.set.apply(this,arguments));this._isInitialized||this.isLocked()?s&&s!==n&&c.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),!s&&0!==s||c.Relational.store.register(this),this.initializeRelations(i)),o&&this.updateRelations(o,i)}finally{c.Relational.eventQueue.unblock()}return l},clone:function(){var t=h.clone(this.attributes);return h.isUndefined(t[this.idAttribute])||(t[this.idAttribute]=null),h.each(this.getRelations(),function(e){delete t[e.key]}),new this.constructor(t)},toJSON:function(i){if(this.isLocked())return this.id;this.acquire();var s=c.Model.prototype.toJSON.call(this,i);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in s||(s[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),h.each(this._relations,function(e){var t=s[e.key],o=e.options.includeInJSON,n=null;!0===o?t&&h.isFunction(t.toJSON)&&(n=t.toJSON(i)):h.isString(o)?(t instanceof c.Collection?n=t.pluck(o):t instanceof c.Model&&(n=t.get(o)),o===e.relatedModel.prototype.idAttribute&&(e instanceof c.HasMany?n=n.concat(e.keyIds):e instanceof c.HasOne&&((n=n||e.keyId)||h.isObject(e.keyContents)||(n=e.keyContents||null)))):h.isArray(o)?t instanceof c.Collection?(n=[],t.each(function(t){var i={};h.each(o,function(e){i[e]=t.get(e)}),n.push(i)})):t instanceof c.Model&&(n={},h.each(o,function(e){n[e]=t.get(e)})):delete s[e.key],o&&(s[e.keyDestination]=n),e.keyDestination!==e.key&&delete s[e.key]}),this.release(),s}},{setup:function(e){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?c.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,h.each(this.prototype.relations||[],function(e){var t,i;e.model||(e.model=this),e.reverseRelation&&e.model===this&&(i=!0,(i=h.isString(e.relatedModel)?(t=c.Relational.store.getObjectByName(e.relatedModel))&&t.prototype instanceof c.RelationalModel:i)?c.Relational.store.initializeRelation(null,e):h.isString(e.relatedModel)&&c.Relational.store.addOrphanRelation(e))},this),this},build:function(e,t){return this.initializeModelHierarchy(),new(this._findSubModelType(this,e)||this)(e,t)},_findSubModelType:function(e,t){if(e._subModels&&e.prototype.subModelTypeAttribute in t){var i=t[e.prototype.subModelTypeAttribute],o=e._subModels[i];if(o)return o;for(i in e._subModels)if(o=this._findSubModelType(e._subModels[i],t))return o}return null},initializeModelHierarchy:function(){var e;this.inheritRelations(),this.prototype.subModelTypes&&(e=h.keys(this._subModels),e=h.omit(this.prototype.subModelTypes,e),h.each(e,function(e){e=c.Relational.store.getObjectByName(e);e&&e.initializeModelHierarchy()}))},inheritRelations:function(){var e;(h.isUndefined(this._superModel)||h.isNull(this._superModel))&&(c.Relational.store.setupSuperModel(this),this._superModel?(this._superModel.inheritRelations(),this._superModel.prototype.relations&&(e=h.filter(this._superModel.prototype.relations||[],function(t){return!h.any(this.prototype.relations||[],function(e){return t.relatedModel===e.relatedModel&&t.key===e.key},this)},this),this.prototype.relations=e.concat(this.prototype.relations))):this._superModel=!1)},findOrCreate:function(e,t){t=t||{};var i=h.isObject(e)&&t.parse&&this.prototype.parse?this.prototype.parse(h.clone(e)):e,o=this.findModel(i);return h.isObject(e)&&(o&&!1!==t.merge?(delete t.collection,delete t.url,o.set(i,t)):o||!1===t.create||(o=this.build(i,h.defaults({parse:!1},t)))),o},find:function(e,t){return(t=t||{}).create=!1,this.findOrCreate(e,t)},findModel:function(e){return c.Relational.store.find(this,e)}}),h.extend(c.RelationalModel.prototype,c.Semaphore),c.Collection.prototype.__prepareModel=c.Collection.prototype._prepareModel,c.Collection.prototype._prepareModel=function(e,t){var i;return e instanceof c.Model?(e.collection||(e.collection=this),i=e):(i=void 0!==((t=t?h.clone(t):{}).collection=this).model.findOrCreate?this.model.findOrCreate(e,t):new this.model(e,t))&&i.validationError&&(this.trigger("invalid",this,e,t),i=!1),i};var s=c.Collection.prototype.__set=c.Collection.prototype.set,n=(c.Collection.prototype.set=function(e,t){if(!(this.model.prototype instanceof c.RelationalModel))return s.apply(this,arguments);t&&t.parse&&(e=this.parse(e,t));var i=!h.isArray(e),o=[],n=[],e=(e=i?e?[e]:[]:h.clone(e),h.each(e,function(e){(e=e instanceof c.Model?e:c.Collection.prototype._prepareModel.call(this,e,t))&&(n.push(e),this.get(e)||this.get(e.cid)?null!=e.id&&(this._byId[e.id]=e):o.push(e))},this),n=i?n.length?n[0]:null:n,s.call(this,n,h.defaults({parse:!1},t)));return h.each(o,function(e){(this.get(e)||this.get(e.cid))&&this.trigger("relational:add",e,this,t)},this),e},c.Collection.prototype.__remove=c.Collection.prototype.remove),i=(c.Collection.prototype.remove=function(e,t){if(!(this.model.prototype instanceof c.RelationalModel))return n.apply(this,arguments);var i=!h.isArray(e),o=[],e=(e=i?e?[e]:[]:h.clone(e),t=t||{},h.each(e,function(e){(e=this.get(e)||e&&this.get(e.cid))&&o.push(e)},this),n.call(this,i?o.length?o[0]:null:o,t));return h.each(o,function(e){this.trigger("relational:remove",e,this,t)},this),e},c.Collection.prototype.__reset=c.Collection.prototype.reset),o=(c.Collection.prototype.reset=function(e,t){t=h.extend({merge:!0},t);e=i.call(this,e,t);return this.model.prototype instanceof c.RelationalModel&&this.trigger("relational:reset",this,t),e},c.Collection.prototype.__sort=c.Collection.prototype.sort),l=(c.Collection.prototype.sort=function(e){var t=o.call(this,e);return this.model.prototype instanceof c.RelationalModel&&this.trigger("relational:reset",this,e),t},c.Collection.prototype.__trigger=c.Collection.prototype.trigger);c.Collection.prototype.trigger=function(e){return this.model.prototype instanceof c.RelationalModel?("add"===e||"remove"===e||"reset"===e||"sort"===e?(t=this,i=arguments,h.isObject(i[3])&&((i=h.toArray(i))[3]=h.clone(i[3])),c.Relational.eventQueue.add(function(){l.apply(t,i)})):l.apply(this,arguments),this):l.apply(this,arguments);var t,i},c.RelationalModel.extend=function(e,t){var i=c.Model.extend.apply(this,arguments);return i.setup(this),i}});
define(["analytics","commonService","formService"],function(){"use strict";var l=null,r=null,i=null;function e(){l=new IEA.Analytics,r=new IEA.commonService,i=new IEA.formService}return _.extend(e.prototype,{defaultSettings:{primaryContactNumber:"#contact-phoneNumbers-0-type",primaryContactNumberValue:"primary",previewBlock:".c-preview-block",disableFieldsWithProfileData:"disableFieldsWithProfileData",hideFieldsString:"hideFieldsWithProfileData",preFillFieldsWithProfileData:"preFillFieldsWithProfileData",editLinkText:".c-edit-link-text",emailInputField:'input[name="contact-email"]',rewardsEntity:"rewards"},_pageLoadMethods:function(){var e=this.$el.find(this.settings.emailInputField);this._hasBodyClass(this.settings.signUpPage)&&e.length&&(this._prepopulateEmailByLocalStorage(e),r._getCookie("dtprofileDataUrl")&&this.tokenCookie&&this._prepopulateEmailByCookie(e)),this._prePopulateFormDataHandler()},_prepopulateEmailByLocalStorage:function(e){var a=this.randomNumber+"-"+this.compLocale+"-userEmailAddress";r.getLocalStorageItem(a)&&(e.val(r.getLocalStorageItem(a)),localStorage.removeItem(a))},_prepopulateEmailByCookie:function(a){var e={queryParams:"",servletUrl:r._getCookie("dtprofileDataUrl"),isTypePost:!1,onCompleteCallback:function(e){e=JSON.parse(e),a.val(e.EmailAddress)}};r.getDataAjaxMethod(e)},_prmDataToSend:function(e){var a="diagnosticToolSignupSurveyResponses";if(r.getLocalStorageItem(a,!0))return a=i.getMultipleLocalStorageMergedData(a,this.compLocale,!0),a=JSON.parse(a),e=JSON.parse(e),JSON.stringify($.extend(a,e))},_prePopulateFormDataHandler:function(){var e=this,a=e.modelData.analytics.usageContext,t="user-preferences"===e.modelData.formType,i=r.getQueryStringVal("ulidh"),o=!!$(".wcmmode-edit").length;e.modelData.preFillFormWithProfileData&&(void 0!==e.tokenCookie||t&&i)?(e._prePopulateSignupData(i),"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&l.trackCampaignSteps(a,digitalData)):t&&!o&&e.modelData.validationFailedRedirectPath&&(window.location.href=e.modelData.validationFailedRedirectPath)},_prePopulateSignupData:function(e){var a=this,t=a.compJson,i={},o=a.$form.find('[name="form-data-url"]').val(),l=a.$el.find('[name="entity"]').val(),i={brand:t.brandName,entity:l,locale:t.locale};e&&(i.ulidh=e),e={queryParams:"?"+$.param(i),servletUrl:o,header:{brand:t.brandName,locale:t.locale},onCompleteCallback:function(e){var e=JSON.parse(e);400===e.code||404===e.code?t.validationFailedRedirectPath&&(window.location.href=t.validationFailedRedirectPath):(e.responseData&&a._allowEditingOfSavedData(e.responseData,a.clonedObjSignUp),l===a.settings.rewardsEntity&&(e=0===(e=a.$form.find(a.settings.primaryContactNumber)).length?a.$form.find("[name='"+a.settings.primaryContactNumber.slice(1)+"']"):e).length&&""===e.val()&&e.val(a.settings.primaryContactNumberValue),a.$form.find(a.settings.emailInputField)&&a.$form.find(a.settings.emailInputField).attr("readonly",!0))}},r.getDataAjaxMethod(e)},_editableView:function(e){e.preventDefault(),this.$form.addClass("editable"),this.$form.find(this.settings.previewBlock).remove(),this._prePopulateSignupData()},_allowEditingOfSavedData:function(e,a){var t=this,e=i.jsonToForm(e);a=$.extend(a,e),t.modelData.allowEditingOfSavedData&&t.modelData.allowEditingOfSavedData.trim()===t.settings.preFillFieldsWithProfileData?(t.$form.find(t.settings.editLinkText).text(t.modelData.editLinkText),t.$form.addClass(t.settings.preFillFieldsWithProfileData)):t.modelData.allowEditingOfSavedData&&t.modelData.allowEditingOfSavedData.trim()===t.settings.hideFieldsString?(t.$form.addClass(t.settings.hideFieldsString),t.$form.find(t.settings.previewBlock).addClass("hidden")):t.$form.addClass(t.settings.disableFieldsWithProfileData),i.populateFormData(e,t.$form)},_addUlidHashcodeData:function(e){var a=r.getQueryStringVal("ulidh"),e=JSON.parse(e);return e.cusUlidhash=a,JSON.stringify(e)},_sendQuickpollDiagnosticToolData:function(){var e,a,t=this;r.getLocalStorageItem("QuickpollSurveyResponses")&&(a=r.getLocalStorageItem("QuickpollSurveyResponses"),e=r.getLocalStorageItem("quickpollLoginUrl"),t._surveyDataSubmissionHandler(e,a,"Quickpoll")),r.getLocalStorageItem(t.compLocale+"-diagnosticToolSignupSurveyResponses",!0)&&(a=i.getMultipleLocalStorageMergedData("diagnosticToolSignupSurveyResponses",t.compLocale,!0),r.getLocalStorageItem(t.compLocale+"-surveyPostURL",!0)&&(e=JSON.parse(i.getMultipleLocalStorageMergedData("surveyPostURL",t.compLocale,!0))[0]),t._surveyDataSubmissionHandler(e,a,"Diagnostic Tool"))},_surveyDataSubmissionHandler:function(e,a,t){e=$.ajax({type:"POST",url:e,crossDomain:!0,async:!1,contentType:"application/json",dataType:"json",data:a});$.proxy(e,t)}}),e});
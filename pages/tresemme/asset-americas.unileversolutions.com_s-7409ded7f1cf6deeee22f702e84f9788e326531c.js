define(["commonService","analytics","lazyLoadService"],function(){"use strict";var C=null,w=null,u=null;IEA.service("ratingService",function(m,e,t){function a(){return this}return _.extend(a.prototype,{initialize:function(e){return C=new IEA.commonService,w=new IEA.Analytics,u=new IEA.LazyLoad,this},preRatings:function(e){var t=this;u.lazyLoadFeature(e.elm,function(){t.initRatings(e)})},initRatings:function(r){var e,n=this;$(document).ajaxSuccess(function(e,t,a){r.ratingReview&&"kritique"===r.ratingReview.serviceProviderName&&t.responseJSON&&t.responseJSON.Entities&&digitalData.page.pageInfo.pageName===t.responseJSON.Entities[0].EntityName&&n._updateDataLayer(t.responseJSON.Entities[0].AverageRating,t.responseJSON.Entities[0].ReviewCount)}),void 0===r.ratingReview||"true"!==r.ratingReview.enabled&&!0!==r.ratingReview.enabled||("kritique"===(e=r.ratingReview.serviceProviderName)?(this._loadKQScript(r),this._checkKritiqueSettings(r)):"bazaarvoice"===e&&this._checkScriptBazaarVoice(r))},_loadKQScript:function(e){var t,a,r,n=e.ratingReview,i=n.brandId,e=e.brandName,o=n.localeId,c=n.apiKey,s=n.serviceURI,d=n.sitesource,n=n.id;0===$("script[src*='RR_widget_config.js']").length&&0===$("script[src*='RR_widget.js']").length&&0===$("script[src*='RR_widget-v2.js']").length&&(t=document.createElement("script"),a=document.getElementsByTagName("script")[0],r=document.createElement("script"),u.preLoader(a,!0),t.type="text/javascript",t.async=!0,t.id=n,t.src=s+"?brandid="+i+"&localeid="+o+"&apikey="+c+"&siteSource="+d,a.parentNode.insertBefore(t,a),IEA.currentInstance.getValue("addRRConfig")&&(r.type="text/javascript",r.async=!0,r.src=C.getJsConfigUrl(e)+"/config/RR_widget_config.js",a.parentNode.insertBefore(r,a)),u.preLoader(a,!1))},_loadBazaarVoiceScript:function(e,t){var e=e.ratingReview,a=document.createElement("script");u.preLoader(a,!0),a.type="text/javascript",a.async=!0,a.readyState?a.onreadystatechange=function(){"loaded"!==a.readyState&&"complete"!==a.readyState||(a.onreadystatechange=null,t())}:a.onload=function(){t()},a.src=e.serviceURI,document.querySelector("head").appendChild(a),u.preLoader(a,!1)},_kritiqueRatings:function(e){void 0!==e.widget&&e.widget.rrReloadWidget()},_checkScriptBazaarVoice:function(e){var a=this;function t(t){t.ratingObj&&"primary"===t.ratingObj.viewType&&$BV.configure("global",{events:{bvRender:function(e){a._ctProductInfo(t,"render"),a._updateDataLayer($(".bv_avgRating").text(),$(".bv_numReviews_text").text().replace(/[()]/g,""))},submissionLoad:function(e){a._ctProductInfo(t,"open")},submissionClose:function(e){a._ctProductInfo(t,"close")},submissionSubmitted:function(e){a._ctProductInfo(t,"reviews")}}})}0===$("script[src*='bv.js']").length?this._loadBazaarVoiceScript(e,function(){window.$BV&&t(e)}):window.$BV&&"object"==typeof $BV?t(e):$("script[src*='bv.js']").on("load",function(){window.$BV&&t(e)})},_trackCurrentComponent:function(e,r){var n=this;$(document).on("click",e,function(){var e,t=$(this).parents("[data-componentname]"),t=(t.data("componentname")?t:$(r.elm)).data("componentname"),a=$(r.elm).data("componentname");ratingReview.events=ratingReview.events||{},event&&event.target&&((e=$(event.target).parents(".rr-widget-container"))&&e.length&&(r.productName=e.attr("title")||e.attr("data-title")||e.attr("data-entity-name"),r.productId=e.data("uniqueId"))),t!==a&&"reviews"!==t||$.extend(ratingReview.events,{rrRender:function(){n._ctProductInfo(r,"render")},rrWriteReview:function(){n._ctProductInfo(r,"open")},rrFormClose:function(){n._ctProductInfo(r,"close")},rrHelpful:function(){n._ctProductInfo(r,"helpful")},rrUnHelpful:function(){n._ctProductInfo(r,"nothelpful")},rrReported:function(){n._ctProductInfo(r,"reported")},rrSubmitReview:function(){n._ctProductInfo(r,"reviews")},rrSubmitMultipleReviews:function(){n._ctProductInfo(r,"submitmultiplereviews")},rrCarouselOpen:function(){n._ctProductInfo(r,"carouselOpen")},rrCarouselNextSlide:function(){n._ctProductInfo(r,"carouselNextSlide")},rrCarouselPrevSlide:function(){n._ctProductInfo(r,"carouselPrevSlide")},rrCarouselNextMediaPage:function(){n._ctProductInfo(r,"carouselNextMediaPage")},rrCarouselPrevMediaPage:function(){n._ctProductInfo(r,"carouselPrevMediaPage")},rrVideoClickAnalytic:function(){n._ctProductInfo(r,"videoClickAnalytic")}})})},_checkKritiqueSettings:function(e){var a=this;function t(e){var t=e.elm.parent().attr("id");a._trackCurrentComponent("#"+t+" .write-review-btn, #"+t+" .wRtng",e),a._trackCurrentComponent("#rr-modalWidowcontainer .closeButton",e),a._trackCurrentComponent(".helpful",e),a._trackCurrentComponent(".un-helpful",e),a._trackCurrentComponent(".report-btn",e),a._trackCurrentComponent(".tReview",e),a._trackCurrentComponent(".rr-carousel-thumnail",e),a._trackCurrentComponent(".rr-carousel-next",e),a._trackCurrentComponent(".rr-carousel-prev",e),a._trackCurrentComponent(".slide-active .video-iframe .video-play",e)}0===$("script[src*='RR_widget.js']").length?this._loadKQScript(e,function(){t(e)}):$("script[src*='RR_widget.js']").on("load",function(){t(e)})},_ctProductInfo:function(e,t){var a,r,n,i,o,c,s,d,u,l,p=e.ratingReview.serviceProviderName,v={},g="review"===C.trimString(C.getQueryParams("intent",!0)).toLowerCase(),f="purchase"===C.trimString(C.getQueryParams("intent",!0)).toLowerCase();if("undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants)if(g&&"open"===t||f&&"render"===t)e.reviewIntent=g,w.trackReviewIntent(e,digitalData);else{switch(w.trackComponentInfo(e.elm,digitalData),t){case"open":a="bazaarvoice"===p?ctConstants.bvopen:ctConstants.rrOpen;break;case"render":a="bazaarvoice"===p?ctConstants.bvrenders:ctConstants.rrRenders;break;case"close":a="bazaarvoice"===p?ctConstants.bvclose:ctConstants.rrClose;break;case"reviews":case"submitmultiplereviews":a=ctConstants.ratingreview;break;case"helpful":a="bazaarvoice"===p?"":ctConstants.rrHelpful;break;case"nothelpful":a="bazaarvoice"===p?"":ctConstants.rrNotHelpful;break;case"reported":a="bazaarvoice"===p?"":ctConstants.rrReported;break;case"read":a=ctConstants.readReviews;break;case"carouselOpen":a="bazaarvoice"===p?"":ctConstants.imageclick;break;case"carouselNextSlide":a="bazaarvoice"===p?"":ctConstants.imagerightscrollclick;break;case"carouselPrevSlide":a="bazaarvoice"===p?"":ctConstants.imageleftscrollclick;break;case"carouselNextMediaPage":a="bazaarvoice"===p?"":ctConstants.imagerightscrollclick;break;case"carouselPrevMediaPage":a="bazaarvoice"===p?"":ctConstants.imageleftscrollclick;break;case"videoClickAnalytic":a="bazaarvoice"===p?"":ctConstants.videoclick}e.recipes||e.recipeId?(f=e.recipeName,g=e.recipes||e.recipeId,digitalData.product=[],digitalData.product.push({productInfo:{productID:g,productName:f}}),v.eventInfo={type:ctConstants.trackEvent,eventAction:a,eventLabel:f,eventValue:1}):(g=e.productId,r=e.productName,f=void 0!==e.productCategory?e.productCategory:"",e=e.productVariants,n=$(".rr-product-reviews"),i=$(".c-product-overview"),o=$(".js-product-images-thumbnail"),c=$(".c-reviews ul li[data-productid]"),s=[],d=[],u=[],l=[],n.length&&(g=n.attr("data-unique-id"),n.siblings("#productName").length?(r=n.siblings("#productName").val(),e=n.data("product-variant")):i.length?(r=i.data("product-name"),e=i.data("product-variant")):o.length?(r=o.data("product-name"),e=o.data("product-variant")):n.data("entity-name")&&n.data("entity-name").length&&(r=n.data("entity-name"),e=n.data("product-variant")),1<c.length&&("render"===t?(c.each(function(){s.push($(this).attr("data-productid")),d.push($(this).find("h4.product-name").text().trim())}),r=d.join(" | ")):"submitmultiplereviews"===t&&(c.each(function(){var e=$(this);e.find("li:first input").hasClass("valid")&&e.find("textarea").hasClass("valid")&&e.find(".postReviewStarRating input").hasClass("valid")&&(s.push(e.attr("data-productid")),d.push(e.find("h4.product-name").text().trim()))}),r=d.join(" | ")),u=s.join(" | "),l=d.join(" | "))),digitalData.product=[],1<c.length?digitalData.product.push({productInfo:{productID:u,productName:l},category:{primaryCategory:f},attributes:{productVariants:e}}):digitalData.product.push({productInfo:{productID:g,productName:r},category:{primaryCategory:f},attributes:{productVariants:e}}),v.eventInfo={type:ctConstants.trackEvent,eventAction:a,eventLabel:r,eventValue:1},"render"===t&&(v.attributes={nonInteractive:{nonInteraction:1}})),v.category="render"===t?{primaryCategory:ctConstants.custom}:"carouselOpen"===t||"carouselNextSlide"===t||"carouselPrevSlide"===t||"videoClickAnalytic"===t||"carouselNextMediaPage"===t||"carouselPrevMediaPage"===t?{primaryCategory:ctConstants.engagement}:{primaryCategory:ctConstants.advocacy},v.subcategory="render"===t||"carouselOpen"===t||"videoClickAnalytic"===t?"Read":"close"===t?"Others":"Interest","bazaarvoice"!==p&&ratingReview&&(!ratingReview.hasOwnProperty("carouselData")||"carouselOpen"!==t&&"videoClickAnalytic"!==t||(v.eventInfo.eventLabel=ratingReview.carouselData.destinationImg),"carouselNextMediaPage"!==t&&"carouselPrevMediaPage"!==t||(v.eventInfo.eventLabel=r+" | Media Carousel")),"bazaarvoice"===m&&"render"===t&&(v.attributes={nonInteractive:{nonInteraction:1}}),digitalData.event.push(v)}},_updateDataLayer:function(e,t){t&&window.digitalData&&(window.digitalData.page.entity?(window.digitalData.page.entity.ratings=e,window.digitalData.page.entity.reviewCount=t):window.digitalData.page.entity={ratings:e,reviewCount:t})}}),a})});
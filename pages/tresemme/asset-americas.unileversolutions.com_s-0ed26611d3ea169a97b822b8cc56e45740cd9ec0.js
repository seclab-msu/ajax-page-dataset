define(["xregexp"],function(){"use strict";function e(){}return _.extend(e.prototype,{_bindBackboneValidations:function(){var o=this;Backbone.Validation.bind(this,{valid:function(e,n){var r=e.$("[name="+n+"]"),t=r.closest(o.settings.formGroup),i=t.find("[type=file]"),a=!1;o.$validField=t.find(".form-element-valid"),e.model&&e.model.warningMsgConfigured&&e.model.warningMsgConfigured[n]&&(a=!0),0<t.children(".multivalue").length?((e=$("input[name="+n+"]").parents(".multivalue-field")).removeClass(o.settings.formError),a||e.find(o.settings.helpBlock).html("").addClass("hidden")):(a||t.find(o.settings.helpBlock).html("").addClass("hidden"),t.removeClass(o.settings.formError),!t.find(".captcha").length&&o.modelData.dynamicConditionValidator?(i.length&&""!==i.val()||!i.length)&&((n=r.val())&&n.trim().length&&!a&&o.$validField.removeClass("hidden"),r.addClass("form-input-valid"),r.hasClass("form-input-error")&&r.removeClass("form-input-error")):t.find(".captcha").length||t.addClass("form-valid"),r.data("char-count-enabled")&&r.data("char-length")&&r.val().length>r.data("char-length")&&(r.addClass("form-input-valid"),t.find(o.settings.helpBlock).html(r.data("char-length-error-msg")).removeClass("hidden")))},invalid:function(e,n,r){var e=e.$("[name="+n+"]"),t=e.closest(o.settings.formGroup),n=$("input[name="+n+"]").parents(".multivalue-field"),n=t.children(".multivalue").length?n:t,i=t.parents(o.settings.componentWrapper);o.$validField=t.find(".form-element-valid"),!0===r&&(r=e.attr("invalid-input")),i.is(":visible")&&(o.modelData.dynamicConditionValidator?(o.$validField.addClass("hidden"),t.find(o.settings.helpBlock).removeClass("form-element-warning").addClass("form-element-error"),e.addClass("form-input-error"),t.find(o.settings.helpBlock).html(r).removeClass("hidden")):n.addClass(o.settings.formError).find(o.settings.helpBlock).html(r).removeClass("hidden"))}})},_validatorExtended:function(){var d=this;_.extend(Backbone.Validation.validators,{customWarning:function(e,n,r,t,i){t.warningMsgConfigured||(t.warningMsgConfigured=[]),t.warningMsgConfigured[n]=!1,r.test(e)||(r=i.data.formV2.formElementsV2Config.find(function(e){return e.formElementV2&&e.formElementV2.fieldId===n}).formElementV2.warningSet[0].msg,$("[name="+n+"]").parent().find(".help-block").removeClass("hidden").addClass("form-element-warning").html(r),t.warningMsgConfigured[n]=!0)},required:function(e,n,r,t,i){var a=$("form:visible").find('[name="'+n+'"]:checkbox'),o=$("form:visible").find('[name="'+n+'"]:radio'),s=$("form:visible").find('[name="'+n+'"]:file'),t=_.isFunction(r)?r.call(t,e,n,i):r;return!(!t&&!e)&&(t&&(a.length||o.length||s.length)?!(a.filter(":checked").length||o.filter(":checked").length||s.val()):!(!t||e)||void 0)},dateValidation:function(e,n,r,t,i){var a,o=new Date,s=new Date(e),l=!1;switch(r.condition.toLowerCase()){case"mustbewithinnext":a=d._dateValidation(r,"+"),o<s&&s<a||(l=!0);break;case"mustbewithinlast":a=d._dateValidation(r,"-"),s<o&&a<s||(l=!0);break;case"mustnotbewithinlast":a=d._dateValidation(r,"-"),s<o&&s<a||(l=!0);break;case"mustnotbewithinnext":a=d._dateValidation(r,"+"),o<s&&a<s||(l=!0)}return l},validateFile:function(e,n,r,t,i){var a,o=!0,n=0!==d.$form.find("[name="+n+"]").length?d.$form.find("[name="+n+"]")[0].files:[];return _.each(n,function(e){a=void 0!==e.size?e.size:0,d._validateFile(r,e.name.split(".").reverse()[0],a)&&(o=!1)}),o}})},requiredMethod:function(e,n){var r=this;$.isArray(e)?e.forEach(function(e,n){r._requiredByName(e.attrName,e.validateFlag)}):r._requiredByName(e,n)},_removeMandatory:function(e){var r=this;function t(e){var n=$("label[for='"+e+"']");(n=0===n.length?r.$form.find("[name='"+e+"']").parents(".form-group").find("label"):n).find(".c-form-mandatory").hide(),r.requiredMethod(e,!1)}$.isArray(e)?e.forEach(function(e,n){t(e)}):"string"==typeof e&&t(e)},_requiredByName:function(e,n){for(var r,t=this,i=this.moduleName.hyphenToCamelCase(),a=this.getModelJSON()[i].formElementsV2Config,o=0,s={},i={},o=0;o<a.length;o++)null!==a[o]&&void 0!==(r=a[o].formElementV2)&&void 0!==r.rules&&_.isArray(r.rules)&&r.name===e&&((s=r.rules[0]).required=n),r&&t.multiValueFields&&(t.multiValueFields[r.fieldId]={name:e,rules:{required:n,msg:s.msg}});void 0!==t.multiValueFields[e]&&(i[e]=t.multiValueFields[e].rules,t.validator.addRules(t,{rules:i}))},_idExistInArray:function(e,n){return e.some(function(e){return n.formElementV2&&!n.formElementV2.fieldId&&n.formElementV2.groupName?e.formElementV2&&e.formElementV2.groupName===n.formElementV2.groupName:n.formElementV2&&e.formElementV2&&e.formElementV2.fieldId===n.formElementV2.fieldId})},_createValidationRules:function(){var e,n,r=this,t=[],i={},a={},o=0,s=0,l=require("xregexp");for(_.each(r.allElementsConfig,function(e,n){r._idExistInArray(t,e)||t.push(e)}),_.each(r.formElementGroup,function(e,n){_.each(e.formElements,function(e,n){r._idExistInArray(t,e)||t.push(e)})});o<t.length;o++)if(null!==(e=t[o])&&!_.isFunction(e.formElement)&&e.formElementV2&&(""!==e.formElementV2.fieldId||""!==e.formElementV2.groupName)){var d=e.formElementV2.surveyPrefix?e.formElementV2.surveyPrefix+"-answer":e.formElementV2.fieldId||e.formElementV2.groupName,m=e.formElementV2.elementType||"";if(a[d]=[],void 0!==e.formElementV2.rules&&_.isArray(e.formElementV2.rules))for(s=0;s<e.formElementV2.rules.length;s++)r.isvalidationRequired=!0,i=e.formElementV2.rules[s],a[d].push({xss:!0}),_.has(i,"pattern")?"creditcard"===i.pattern?a[d].push({creditcard:!0,msg:i.msg}):(n=decodeURIComponent(encodeURIComponent(i.pattern)).replace(/%24/g,"$"),a[d].push({pattern:this.validator.patterns[n]||new l(n),msg:i.msg})):"fileupload"!==m||void 0!==i.required?a[d].push(i):a[d].push({validateFile:i,msg:i.msg});if(e.formElementV2.fieldId&&e.formElementV2.fieldId.indexOf("birthday")<0&&void 0!==e.formElementV2.warningSet&&_.isArray(e.formElementV2.warningSet))for(s=0;s<e.formElementV2.warningSet.length;s++)r.isvalidationRequired=!0,i=e.formElementV2.warningSet[s],_.has(i,"pattern")?"creditcard"===i.pattern?a[d].push({creditcard:!0,msg:i.msg}):(n=decodeURIComponent(encodeURIComponent(i.pattern)).replace(/%24/g,"$"),a[d].push({customWarning:this.validator.patterns[n]||new l(n),msg:i.msg})):_.has(i,"condition")?a[d].push({dateValidation:i,msg:i.msg}):a[d].push(i)}return a},_formElementsGroupHandler:function(){var r,t,i=this.$form.find(this.settings.formElementsGroupSection),a=0,o=0,s=0;return _.each(this.allElementsConfig,function(e,n){e.formElementsGroup&&(e.formElementsGroup.mandatoryQuestionFlag&&(t=i.eq(s),r=t.find(".form-group"),o++,t.is(":visible")&&!(r.find('input[type="checkbox"]:checked').length||r.find('input[type="radio"]:checked').length||r.find("select").hasClass("form-input-valid"))?(r.add(t).addClass("has-error"),0===t.find(".form-elements-group-error").length?t.prepend("<span class='help-block form-elements-group-error'>"+e.formElementsGroup.requiredErrorMessage+"</span>"):t.find(".form-elements-group-error").removeClass("hidden")):(r.add(t).removeClass("has-error"),t.find(".form-elements-group-error").addClass("hidden"),a++)),s++),e.formElementsGroup&&r&&r.find('input[type="text"]').length&&r.add(t).hasClass("has-error")&&(r.add(t).removeClass("has-error"),t.find(".form-elements-group-error").addClass("hidden"),a++)}),a===o},_campaignQuesAnswerHandler:function(){var r=this,t=r.$form.find(r.settings.campaignQuestionAndAnswersSection),i=t.find(".checkbox"),a=t.find(".radio"),o=0,s=0,l=0;return _.each(r.allElementsConfig,function(e,n){e.campaignQuestionAndAnswers&&e.campaignQuestionAndAnswers.isMandatory&&(e=e.campaignQuestionAndAnswers,(t=e.generalConfigData.surveyQuestionId?r.$form.find('.js-question[data-survey-que-id="'+e.generalConfigData.surveyQuestionId+'"]'):t).length&&("singleChoiceQuestion"===e.questionType||"singleChoiceQuestionInteractive"===e.questionType?(o++,0===(a=t.find(".radio").parents(".c-res-wrap")).find(".res-active").length?(a.addClass("has-error"),0===t.find(".form-elements-group-error").length?t.append("<span class='help-block form-elements-group-error'>"+e.mandatoryErrorText+"</span>"):t.find(".form-elements-group-error").removeClass("hidden")):(a.removeClass("has-error"),t.find(".form-elements-group-error").addClass("hidden"),l++)):"multipleChoiceQuestion"!==e.questionType&&"multipleChoiceQuestionInteractive"!==e.questionType||(s++,0===(i=t.find(".checkbox").parents(".c-res-wrap")).find(".res-active").length?(i.addClass("has-error"),0===t.find(".form-elements-group-error").length?t.append("<span class='help-block form-elements-group-error'>"+e.mandatoryErrorText+"</span>"):t.find(".form-elements-group-error").removeClass("hidden")):(i.removeClass("has-error"),t.find(".form-elements-group-error").addClass("hidden"),l++))))}),l===o+s}}),e});
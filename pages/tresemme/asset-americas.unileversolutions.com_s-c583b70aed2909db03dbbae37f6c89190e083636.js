define(["commonService"],function(){"use strict";IEA.service("Analytics",function(t,e,a){function n(){return this}var s=null;return _.extend(n.prototype,{initialize:function(){return s=new IEA.commonService,this.intentToBuy="purchase"===s.trimString(s.getQueryParams("intent",!0)).toLowerCase(),this},trackComponentInfo:function(t,e,a){var n,o,r,i,c,s,d,p,u,m,v,l;t&&void 0!==e&&"undefined"!=typeof ctConstants&&(n=(t=$(t)).data("componentname"),o=t.data("component-variants"),r=t.data("component-positions"),i=t.data("component-experience-variant"),c=t.data("vendor-name"),s=t.data("promo-id"),d=t.data("campaign-usage-context"),t=t.data("tool-name"),m=u=p="",v=[],event&&event.target&&200===event.target.status?($("input:checked.c-form-radio__input.c-form-survey-field,input:checked.c-form-checkbox.c-form-survey-field,option:selected.c-form-dropdown.c-form-survey-field").not(":disabled").each(function(){p="","radio"===this.type?m+=$("[name="+this.name.split("answers")[0]+"question]")[0].value.split(":")[0].toLowerCase()+":"+$(this).parent().find(".c-form-radio__label").text().trim()+"|":"checkbox"===this.type?-1===v.indexOf(this.name.split("answers")[0]+"answers")&&(v.push(this.name.split("answers")[0]+"answers"),$("[name*="+this.name.split("answers")[0]+"answers]:checked").each(function(){p+=$(this).parent().find(".c-form-checkbox__label-copy").text().trim()+","}),p=p.slice(0,-1),m+=$("[name="+this.name.split("answers")[0]+"question]")[0].value.split(":")[0].toLowerCase()+":"+p+"|"):"option"===this.tagName.toLowerCase()&&(m+=$("[for="+this.parentElement.name+"]").text().split(":")[0].toLowerCase()+":"+this.text+"|")}),m=m.slice(0,-1)):event&&event.target&&event.target.type&&$(event.target).hasClass("c-form-survey-field")&&("radio"===(l=event.target.type)?(p=$(event.target).parent().find(".c-form-radio__label").text().trim(),u=$("[name="+event.target.name.split("answers")[0]+"question]")[0].value):"checkbox"===l?($("[name*="+event.target.name.split("answers")[0]+"answers]:checked").each(function(){p+=$(this).parent().find(".c-form-checkbox__label-copy").text().trim()+"|"}),p=p.trim().slice(0,-1),u=$("[name="+event.target.name.split("answers")[0]+"question]")[0].value):"select-one"===l&&(p=event.target.options[event.target.options.selectedIndex].text,u=$("[for="+event.target.id+"]").text()),m=(u?u.split(":")[0].toLowerCase():"")+" : "+(p?p.toLowerCase():"")),e.component=[],e.component.push({componentInfo:{componentID:n,name:n,experienceVariant:i||"default"},attributes:{brandOptin:a||"",position:r,componentVariant:o,reviewVendorName:c||"",promoCreative:s||"",promoID:s||"",promoName:s||"",promoPosition:r,campaignWorkflow:d||"",toolName:t||c||"",surveyQuesAns:m}}))},_trackFormSubmit:function(t,e,a){var n,o;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(digitalData.form={field:{}},e&&(digitalData.form.field=e),$(".form-filtered-survey").length?this._trackSurveyResponse("Survey Submitted"):(e={},o=location.pathname,n=$(".c-form-copy-content__headline:first").text(),o=o.substring(o.lastIndexOf("/")+1,o.lastIndexOf(".")),o=""===n?o:n,n=t.data("form-type")?t.data("form-type"):o,o=t.attr("id"),this.trackComponentInfo(t,digitalData),e.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.forms,eventLabel:n+" - "+o+" - Form Successfully Submitted",eventValue:1},e.category={primaryCategory:ctConstants.engagement},e.subcategory="Lead",a&&(e.eventInfo.eventLabel="Registration-"+a),digitalData.event.push(e)))},_ctTag:function(t,e){var a,n,o,r,i,c,s,d;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},d="",s="cookieq.com/YouTube"===t.videoPlayer.domain?(n="youtube",o=t.player.data("video-id")||t.videoPlayer.videoId,t.hasOwnProperty("autoplay")?t.autoplay:t.videoPlayer.autoplay||t.player.data("video-autoplay")):(n=t.player.data("video-source")||t.videoPlayer.videoSource||t.videoPlayer.m.dataset.videoSource,o=t.player.data("video-id")||t.videoPlayer.videoId||t.videoPlayer.m.dataset.videoId,t.videoPlayer.autoplay||t.player.data("video-autoplay")),d="vimeo"===n?t.videoPlayer.attr("video-title")?t.videoPlayer.attr("video-title"):"":(n=n||"youtube",void 0!==t.videoPlayer.getVideoData?t.videoPlayer.getVideoData().title:""),digitalData.video=[],digitalData.video.push({videoId:o,videoName:d}),i={primaryCategory:ctConstants.engagement},c="Interest",1===t.data||"play"===t.data?((r=s?ctConstants.videoAutoPlays:ctConstants.videoPlays)===ctConstants.videoAutoPlays&&(a.attributes={nonInteractive:{nonInteraction:1}},i={primaryCategory:ctConstants.custom},c="Read"),e()):0!==t.data&&"finish"!==t.data||(r=ctConstants.videoCompletes),a.eventInfo={type:ctConstants.trackEvent,eventAction:r,eventLabel:n+" - "+d+" - "+o,eventValue:1},a.category=i,a.subcategory=c,digitalData.event.push(a))},trackProductInfo:function(t,e,a,n){var o;t&&void 0!==a&&"undefined"!=typeof ctConstants&&e.data&&(o=this.getAwards(t),a.product.push({productInfo:{productID:e.data("product-id"),productName:e.data("product-name"),price:n&&n.price?n.price:e.data("product-price")?e.data("product-price"):"",quantity:n&&n.quantity?n.quantity:e.data("product-quantity")?e.data("product-quantity"):"",sku:void 0!==e.data("product-variant")?e.data("product-variant"):""},attributes:{productPosition:void 0!==e.data("index")?e.data("index"):1,productAward:o,productFindingMethod:(t.data("componentname")?t:t.parents("[data-componentname]")).data("componentname"),productBrand:e.data("product-brand")},category:{primaryCategory:void 0!==e.data("product-category")?e.data("product-category"):""}}))},getAwards:function(t){var e=[];return t.find("[data-award-list]").length?e=t.find("[data-award-list]").data("award-list").split("|"):t.find(".c-award-name").each(function(){e.push($(this).text())}),_.without(e,"")},trackCartwireRetailer:function(t,e){var a,n,o;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},n=$(t).data("component-positions"),o=$(t).data("service-provider"),this.trackComponentInfo(t,digitalData),digitalData.product.push({productInfo:{productID:e.productId,productName:e.productName,price:e.productPrice,brand:e.brandName,quantity:e.quantity},category:{primaryCategory:e.category},attributes:{productVariants:e.productVariant,country:e.country,productRetailer:e.retailerName,listPosition:n||"",integration:o||""}}),a.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.retailerClick,eventLabel:"Online -"+e.productName+"|"+e.retailerName,eventValue:1},a.category={primaryCategory:ctConstants.conversion},a.subcategory="Lead",digitalData.event.push(a))},trackReviewIntent:function(t){var e,a,n;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(e={},a=$(".c-buy-it-now"),n=t.ratingReview.serviceProviderName,n=t.reviewIntent?"bazaarvoice"===n?ctConstants.bazaarVoiceReviewIntent:ctConstants.reviewIntent:"bazaarvoice"===n?ctConstants.bvrenders:ctConstants.rrRenders,this.trackComponentInfo(t.elm,digitalData),digitalData.product.push({productInfo:{productID:t.productId,productName:t.productName,price:a.data("product-price")||"",brand:t.brandName,quantity:""},category:{primaryCategory:a.data("product-category")},attributes:{productVariants:a.data("product-variant")||"",listPosition:a.data("component-positions")||"",integration:a.data("service-provider")||""}}),e.eventInfo={type:ctConstants.trackEvent,eventAction:n,eventLabel:t.productName,eventValue:1},e.category={primaryCategory:ctConstants.engagement},e.subcategory="Interest",e.attributes={nonInteractive:{nonInteraction:1}},digitalData.event.push(e))},trackIntentPurchase:function(t,e){var a;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},e=e,this.trackComponentInfo(t,digitalData),digitalData.product.push({productInfo:{productID:e.data("product-id")||"",productName:e.data("product-name")||"",price:e.data("product-price")||"",brand:e.data("brand")||"",quantity:""},category:{primaryCategory:e.data("product-category")||""},attributes:{productVariants:e.data("product-variant")||"",listPosition:e.data("component-positions")||"",integration:e.data("service-provider")||""}}),a.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.purchaseIntent,eventLabel:"Online - "+e.data("product-name"),eventValue:1},a.category={primaryCategory:ctConstants.conversion},a.subcategory="Lead",a.attributes={nonInteractive:{nonInteraction:1}},digitalData.event.push(a))},trackShopNow:function(t,e,a){var n,o,r;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(n={},r=(o=e).data("product-name"),this.trackComponentInfo(t,digitalData),this.trackProductInfo(t,o,digitalData),n.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.purchase,eventLabel:"Online - "+r,eventValue:1},n.category={primaryCategory:ctConstants.conversion},n.subcategory="Lead",digitalData.event.push(n),a&&"etale"===a.serviceProviderName&&this.etaleTracking(t,e,a))},trackIframeMethod:function(t,e,a,n){var o,r,i=this,c=$(e).data("quick-view")?$(e).find("iframe"):".constantco-widget iframe";this.intentToBuy&&a.componentJson&&a.componentJson.product&&a.componentJson.product.productsDetail&&a.componentJson.product.productsDetail[0].smartProductId&&(o=0,r=setInterval(function(){window.constantco?(clearInterval(r),window.constantco(function(t){t.openSpBasket(a.componentJson.product.productsDetail[0].smartProductId)}),i.trackIntentPurchase(t,e)):5<o&&clearInterval(r),o++},1e3)),setTimeout(function(){require(["iframetracker"],function(){a.$el.find(c).iframeTracker({blurCallback:function(){this.intentToBuy||i.trackShopNow(t,e),n&&s.focusBinWidget("constantCommerce")},overCallback:function(t){this._overId=$(t).attr("id")},outCallback:function(t){this._overId=null},_overId:null})})},900)},etaleTracking:function(t,a,n){"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(this.trackProductInfo(t,a,digitalData),require(["postmessage"],function(){$.receiveMessage(function(t){var e;-1!==n.serviceURL.indexOf(t.origin)&&(e={},void 0!==(t=JSON.parse(t.data).retailer)&&(e.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.retailerClick,eventLabel:"Online - "+a.data("product-name")+" | "+t,eventValue:1},e.category={primaryCategory:ctConstants.conversion},e.subcategory="Lead",digitalData.event.push(e),"object"==typeof $BV&&$BV.SI.trackConversion({type:"BuyOnline",label:t,value:a.data("product-id")})))})}))},storeSearch:function(t,e,a){var n={};"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(this.trackComponentInfo(t,digitalData),this.trackProductInfo(t,e,digitalData),n.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.storesearch,eventLabel:a,eventValue:1},n.category={primaryCategory:ctConstants.engagement},n.subcategory="Interest",digitalData.event.push(n))},trackCampaignSteps:function(t,e){var a,n=$(t).data("campaign-usage-context");n&&void 0!==e&&"undefined"!=typeof ctConstants&&(a={},this.trackComponentInfo(t,e),a.eventInfo={type:ctConstants.campstep,eventAction:ctConstants.campstep,eventLabel:n,eventValue:1},a.category={primaryCategory:ctConstants.engagement},a.subcategory="Interest",e.event.push(a))},trackPurchase:function(t,e,a){var n={};void 0!==a&&"undefined"!=typeof ctConstants&&(this.trackComponentInfo(t,a),n.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.purchase,eventLabel:"Online - "+e,eventValue:1},n.category={primaryCategory:ctConstants.conversion},n.subcategory="Lead",a.event.push(n))},trackEnhancedCheckoutPurchase:function(t,a,n){var e={},o=$.parseJSON(s.getLocalStorageItem("giftingCartData")),r=t.closest("body").hasClass("checkout-form-v2");void 0!==n&&"undefined"!=typeof ctConstants&&(n.product=[],this.trackComponentInfo(t,n),o.productInfo&&_.each(o.productInfo.products,function(t,e){n.product.push({productInfo:{productID:t.variantId,productName:t.title,price:t.price,brand:a,quantity:t.quantity},attributes:{productVariants:t.variant},category:{primaryCategory:""}})}),e.eventInfo={type:r?ctConstants.purchaseenhanced:ctConstants.checkoutenhanced},e.category={primaryCategory:ctConstants.conversion},e.subcategory="Win",n.event.push(e))},inputErrorTracking:function(t,e){var a;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},this.trackComponentInfo(e,digitalData),a.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.inputerror,eventLabel:t,eventValue:1},a.category={primaryCategory:ctConstants.custom},a.subcategory="Error",digitalData.event.push(a))},customEventTracking:function(t,e){var a,n;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},n=window.location.href,this.trackComponentInfo(t,digitalData),t="rememberme"===e?ctConstants.RememberMe:ctConstants.SignOut,a.eventInfo={type:ctConstants.trackEvent,eventAction:t,eventLabel:n,eventValue:1},a.category={primaryCategory:ctConstants.custom},a.subcategory="Interest",digitalData.event.push(a))},trackPricespiderEvents:function(t,e){var a,n=e||{};if("undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants){try{a=JSON.parse(localStorage.pricespiderComponentInfo)}catch(t){a={}}digitalData.component=[],digitalData.component.push({componentInfo:{componentID:a.componentName||"",componentName:a.componentName||""},attributes:{position:a.componentPosition||"",listPosition:a.componentPosition||"",componentVariant:a.componentVariation||""}});var o={};switch(t){case"wtb_open":digitalData.product=[],digitalData.product.push({productInfo:{productID:n.SKU||"",productName:n.productName||"",price:n.price||"",brand:n.brandName||"",quantity:""},category:{primaryCategory:n.productCategory||""},attributes:{productVariants:"",listPosition:""}}),o.eventInfo={type:ctConstants.trackEvent,eventAction:this.intentToBuy?ctConstants.purchaseIntent:ctConstants.purchase,eventLabel:"Online - "+n.productName||"",eventValue:1},o.category={primaryCategory:ctConstants.conversion},o.subcategory="Lead";break;case"wtb_redirect":digitalData.product=[],digitalData.product.push({productInfo:{productID:n.SKU||"",productName:n.productName||"",price:n.price||"",brand:n.brandName||"",quantity:n.size||""},category:{primaryCategory:n.productCategory||""},attributes:{productVariants:n.size||"",country:n.country||"",productRetailer:n.sellerName||"",listPosition:a.componentPosition||"",integration:""}}),o.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.retailerClick,eventLabel:"Online - "+n.productName+"|"+n.sellerName,eventValue:1},o.category={primaryCategory:ctConstants.conversion},o.subcategory="Lead";break;case"wtb_selector":o.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.filter,eventLabel:n.size,eventValue:1},o.category={primaryCategory:ctConstants.engagement},o.subcategory="Interest";break;case"wtb_directions":o.eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.linkClick,eventLabel:a.componentName+"-"+n.productName+"|"+(n.sellerName||"not set")+"-"+(n.storePostalCode||"not set"),eventValue:1},o.category={primaryCategory:ctConstants.engagement},o.subcategory="Read"}digitalData.event.push(o)}},trackListingPromotion:function(t,e){var a,n;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(a={},t=t,n=$(t).parents("[data-role]").find("[data-component-variants]"),digitalData.promotion=[],digitalData.promotion.push({promotionInfo:{promotionId:$(t).find("a").attr("href"),promotionName:$(t).find("img").attr("alt")}}),e&&"view"===e&&(digitalData.component.push({componentInfo:{componentID:n.data("componentname"),componentName:n.data("componentname")},attributes:{position:n.data("componentPositions"),componentVariant:n.data("componentVariants")}}),a.eventInfo={type:ctConstants.promotionView},a.category={primaryCategory:ctConstants.custom},a.subcategory="Load",a.attributes={nonInteractive:{nonInteraction:1}}),digitalData.event.push(a))},_communityLogin:function(t){var e;"undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants&&(digitalData.component.push({componentInfo:{componentID:(t=t).data("componentname"),componentName:t.data("componentname")},attributes:{position:t.data("componentPositions"),listPosition:t.data("componentPositions"),componentVariant:t.data("componentVariants")}}),(e={}).eventInfo={type:ctConstants.trackEvent,eventAction:ctConstants.signIns,eventLabel:t.data("formType"),eventValue:1},e.category={primaryCategory:ctConstants.engagement},e.subcategory="Lead",digitalData.event.push(e))}}),n})});
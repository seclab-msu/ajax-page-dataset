define(["isMobileAdaptive","commonService","lazyLoadService"],function(){"use strict";var l=!1;IEA.service("CommerceService",function(e,t,n){function i(){return this}var o=null,d=null,s=null,c=null,r="//cdn.pricespider.com/1/1750/ps-utid.js",a={constantcommerce:".constantco-widget",click2buy:".clicbuy",pricespider:".ps-widget",intellibrand:".ib-widget"};return _.extend(i.prototype,{initialize:function(e){return o=new IEA.IsMobileAdaptive,d=new IEA.commonService,s=new IEA.LazyLoad,this},handleCommerce:function(e,t,n){var i,r=this.getCommerceConfig(e);r&&(i=r.serviceProviderName?r.serviceProviderName.toLowerCase():"",!o.validate(r,{constantcommerce:1,shoppable:1,click2buy:1,etale:0,cartwire:0,shopalyst:0,pricespider:0,intellibrand:0}[i],e.componentName)&&this.shouldHandleCommerce(r)?(r.componentName=e.componentName,r.intentToBuy="purchase"===d.trimString(d.getQueryParams("intent",!0)).toLowerCase(),this.scriptInjector[i](r,t,n)):(this.swapBinButton(e,{constantcommerce:1,shoppable:1,click2buy:0,cartwire:0,pricespider:0,intellibrand:0}[i]),t&&t(!1)))},swapBinButton:function(e,t){var n=this.getCommerceConfig(e);if(n&&(t||!0)){if(t=n.serviceProviderName?n.serviceProviderName.toLowerCase():"")for(var i=document.querySelectorAll(a[t]),r=0;r<i.length;r++)o.injectLink(n,i[r],e.componentName,!1);$(".disabledOnMobile").addClass("hidden")}},getCommerceConfig:function(e){var t=e.retrivalQueryParams&&e.retrivalQueryParams.product&&e.retrivalQueryParams.product.shopNow||e.shopNow||e.products&&e.products.shopNow;return t&&e&&e.brandName&&(t.brandName=e.brandName,t.locale=e.locale),t},shouldHandleCommerce:function(e){e=!(!e.serviceProviderName||!{constantcommerce:1,shoppable:1,click2buy:1,etale:1,cartwire:1,shopalyst:1,pricespider:1,intellibrand:1}[e.serviceProviderName.toLowerCase()]||"true"!==e.enabled);return e},scriptInjector:{shopalyst:function(e,t){var n,i,r,o,c=this,a=$(".js-shopalyst-btn");e.intentToBuy&&"buyItNow"===e.componentName&&(c.loadShopalystService(e,a,t),require(["analytics"],function(){a=d.getPDPBuyItNow($(".js-shopalyst-btn")),i=new IEA.Analytics,r=a.parents(".c-buy-it-now"),o=a.parents("[data-componentname]"),i.trackIntentPurchase(o,r,e)})),$('script[src*="'+e.serviceURL+'"]').length?($(a).on("click",function(){n=this,c.loadShopalystService(e,n,t)}),"inlineOnPageLoad"===e.widgetType&&(n=$(".c-buy-bin-block"),c.loadShopalystService(e,n,t))):($(a).on("click",function(){n=this,c.loadShopalystService(e,n,t)}),"inlineOnPageLoad"===e.widgetType&&s.lazyLoadFeature($(".merchant-list-holder"),function(){n=$(".c-buy-bin-block"),c.loadShopalystService(e,n,t)}))},loadShopalystService:function(e,t,n){var i=this;null===c?require(["shopalystService"],function(){c=new IEA.shopalystService,i.loadShopalystScript(e,t,n)}):i.loadShopalystScript(e,t,n)},loadShopalystScript:function(t,n,i){var r=$(n).data("product-id");"undefined"==typeof _shopalyst?(s.preLoader(n,!0),require([t.serviceURL],function(){var e=setInterval(function(){"undefined"!=typeof _shopalyst&&(_shopalyst.init(t.publisherId,t.placementId,t.campaignId),"2.0"===t.apiVersion&&t.widgetType?c.selectWidgetType(t.widgetType,n):_shopalyst.addEANToCart(r),clearInterval(e),i(!0))},100)}),s.preLoader(n,!1)):(_shopalyst.init(t.publisherId,t.placementId,t.campaignId),"2.0"===t.apiVersion&&t.widgetType?c.selectWidgetType(t.widgetType,n):_shopalyst.addEANToCart(r),i(!0))},constantcommerce:function(e,t){var n;$('script[src*="'+e.serviceURL+'"]').length?(this.addConstantCommerceWidget(),t&&t(e)):(n=this,window.constantCoAppId=e.applicationID,n.constantcomServiceURL=e.serviceURL,n.constantcomScriptId="constantCoScript","complete"===document.readyState?n.setConstantCommerceScript(t):window.addEventListener("load",$.proxy(n.setConstantCommerceScript,n,t)))},getConstantCommerceScript:function(e){var t=document.createElement("script"),n=this;return t.type="text/javascript",t.async=!0,t.id=n.constantcomScriptId,t.onload=function(){n.addConstantCommerceWidget(),e&&e(!0)},t.src=n.constantcomServiceURL,t},setConstantCommerceScript:function(e){var t,n;document.getElementById(this.constantcomScriptId)?setTimeout(function(){e&&e(!0)},1e3):(t=this.getConstantCommerceScript(e),(n=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,n))},etale:function(e,t){t&&(t(!1),$(".js-etale-bin-button").on("click",function(){d.focusBinWidget("etale")}))},click2buy:function(e,t){var n=$(".clicbuy");n.length&&this.loadScript(e,n,t)},cartwire:function(t){var n,i,r,o,c,a,s=this,e=".js-cartwire-bin-button";$(e).length&&$(e).off("click").on("click",function(e){n=$(e.target),a=n.parents("[data-product-name]"),c=n.parents("[data-componentname]"),s.loadScript(t,n,function(){i=n.attr("data-shopnow-productid"),r=(t.locale||t.market).substring(0,2),o=setInterval(function(){"function"==typeof loadsWidget&&(loadsWidget(i,s,"retailPopup",r),clearInterval(o))},100),require(["analytics"],function(){(new IEA.Analytics).trackShopNow(c,a,t)})}),d.focusBinWidget("cartwire")})},intellibrand:function(i,e){$('script[src*="'+i.serviceURL+'"]').length?e&&e(i):"complete"===document.readyState?this.setIntellibrandScript(e,i):window.addEventListener("load",$.proxy(this.setIntellibrandScript,this,e,i)),$(document).off("click",".btn-intellibrand").on("click",".btn-intellibrand",function(e){var e=$(e.target),t=e.parents("[data-product-name]"),n=e.parents("[data-componentname]");e.siblings(".ib-overlay").removeClass("hidden"),require(["analytics"],function(){(new IEA.Analytics).trackShopNow(n,t,i)})}),$(document).off("click",".ib-widget .o-btn--close").on("click",".ib-widget .o-btn--close",function(e){$(e.target).parents(".ib-overlay").addClass("hidden")})},setIntellibrandScript:function(e,t){var n=this;t.intentToBuy?n.loadIntellibrandScript(e,t):s.lazyLoadFeature($(".ib-widget"),function(){n.loadIntellibrandScript(e,t)})},loadIntellibrandScript:function(t,n){$('script[src*="'+n.serviceURL+'"]').length?t&&t(n):(window._lsConfig={mainColor:n.mainColor,secondaryColor:n.secondaryColor,imgHeight:n.imgHeight,imgWidth:n.imgWidth,loadingMessage:n.loadingMessage},require([n.serviceURL],function(e){t(n)}),this.IntellibrandAnalyticsListener(_lsConfig))},IntellibrandAnalyticsListener:function(e){},pricespider:function(e,t){$('script[src*="'+e.serviceURL+'"]').length?(t&&t(e),this.pricespiderAnalyticsListener()):"complete"===document.readyState?this.setPriceSpiderScript(t,e):window.addEventListener("load",$.proxy(this.setPriceSpiderScript,this,t,e))},setPriceSpiderScript:function(e,t){var n=this;t.intentToBuy?n.loadPriceSpiderScript(e,t):s.lazyLoadFeature($(".ps-widget"),function(){n.loadPriceSpiderScript(e,t)})},loadPriceSpiderAnalyticsJs:function(){var e,t;$('script[src*="'+r+'"]').length||(e=document.createElement("script"),t=document.getElementsByTagName("script")[0],e.type="text/javascript",e.async=!0,e.src=r,t.parentNode.insertBefore(e,t))},loadPriceSpiderScript:function(e,t){var n,i,r,o,c,a,s,d,l=this;$('script[src*="'+t.serviceURL+'"]').length?e&&e(t):(n=t.serviceURL,i=document.createElement("script"),r=document.createElement("meta"),o=document.createElement("meta"),c=document.createElement("meta"),a=t.locale?t.locale.split("-"):"",s=t.key,d=document.getElementsByTagName("script")[0],r.name="ps-key",r.content=s,c.name="ps-language",c.content=a[0]||"",o.name="ps-country",o.content=a[1]||"",i.type="text/javascript",i.async=!0,i.src=n,i.onload=function(){l.loadPriceSpiderAnalyticsJs(),e&&e(t)},d.parentNode.insertBefore(r,d),d.parentNode.insertBefore(c,d),d.parentNode.insertBefore(o,d),d.parentNode.insertBefore(i,d)),l.pricespiderAnalyticsListener()},pricespiderAnalyticsListener:function(){var t;l||(this.bindPricespiderEvent(),require(["analytics"],function(){t=new IEA.Analytics,document.addEventListener("wtb_open",function(e){t.trackPricespiderEvents("wtb_open",e.detail)}),document.addEventListener("wtb_selector",function(e){t.trackPricespiderEvents("wtb_selector",e.detail)}),document.addEventListener("wtb_redirect",function(e){t.trackPricespiderEvents("wtb_redirect",e.detail)}),document.addEventListener("wtb_directions",function(e){t.trackPricespiderEvents("wtb_directions",e.detail)})}),l=!0)},bindPricespiderEvent:function(){this.rebindPriceSpiderWidget(),$(".ps-widget").off("click").on("click",function(e){e=$(e.target).parents("[data-componentname]").data(),e={componentName:e.componentname||"",componentVariation:e.componentVariants||"",componentPosition:e.componentPositions||""};localStorage.pricespiderComponentInfo=JSON.stringify(e)}),d.listenEvent("quickPanelOpened",this.rebindPriceSpiderWidget)},rebindPriceSpiderWidget:function(){"undefined"!=typeof PriceSpider&&PriceSpider.rebind()},loadScript:function(e,t,n){$('script[src*="'+e.serviceURL+'"]').length?n&&(n(!0),e.serviceProviderName&&"click2buy"===e.serviceProviderName&&$(".clicbuy").on("click",function(){d.focusBinWidget("click2buy")})):(s.preLoader(t,!0),d.renderScript(e.serviceURL,!1,function(){n&&(n(e),e.serviceProviderName&&"click2buy"===e.serviceProviderName&&$(".clicbuy").on("click",function(){d.focusBinWidget("click2buy")}))}),s.preLoader(t,!1))},addConstantCommerceWidget:function(){var e;window.ConstantCo&&window.ConstantCo.addWidget&&(e=document.getElementsByClassName("constantco-widget"),_.each(e,function(e){try{window.ConstantCo.addWidget(e)}catch(e){throw new Error(e)}}))},getObject:function(e){var t={};return"v3"===e.apiVersion?(t.token=e.apiToken||"",t.developerMode=e.developerMode||"",t.productGroup=e.productGroup||"",t.site_language=e.siteLanguage||"",t.merchantList=e.merchantList||"",t.order_complete_page=e.orderCompleteUrl||"",t.egrocer_thank_you_page=e.orderCompleteUrl||"",t.page_after_complete_page=e.orderCompletereturnToSiteUrl||"",t.checkout_page=e.publisherCheckoutUrl||"",t.view_cart_page=e.viewBagLink||"",t.campaign=e.campaign||"",t.out_of_stock_message=e.outOfStockText||"",t.out_of_stock_button_text=e.outOfStockCtaLabel||"",t.out_of_stock_link=e.outOfStockUrl||"",t.use_egrocers=JSON.parse(e.useEgrocers)||!1,t.brand_request_name=e.brandRequestName||"",t.brand_privacy_policy_link=e.brandPrivacyPolicyLink||""):(t.token=e.apiToken||"",t.developerMode=e.developerMode||""),t},widgetCallBack:function(e){var t=$(".js-cartwire-bin-button"),n=new IEA.Analytics,t=t.parents("[data-componentname]");n.trackCartwireRetailer(t,e)}},rebindCartwireWidget:function(e){e=this.getCommerceConfig(e);this.scriptInjector.cartwire(e)},etaleIframeHandler:function(e,t,n){e=e.next(t).find("iframe.etale-popup"),t=e[0].dataset.src||e[0].src;n?e[0].src=t+="&cookies=false":e[0].dataset.src&&(e[0].src=t)},loadCartWireWidget:function(e,t,n){var i=setInterval(function(){"function"==typeof loadsWidget&&(loadsWidget(e,n,"retailPopup",t),clearInterval(i))},100)},isShopNowEnabled:function(e){var e=this.getShopNowConfig(e),t=!1;return t=e&&"true"===e.enabled?!0:t},getShopNowConfig:function(e){return e.shopNow||(e.products&&e.products.shopNow?e.products.shopNow:void 0)}}),i})});
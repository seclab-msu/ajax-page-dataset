define(["commonService","formService"],function(){"use strict";var i=null,t=null;function e(){i=new IEA.commonService,t=new IEA.formService}return _.extend(e.prototype,{defaultSettings:{frmTypeParticipation:"campaign-participation-check",frmTypeLocal:"campaign-temporary-data-storage",frmNewUserOnly:"campaign-new-users-only",frmRestrictAccess:"campaign-restrict-access",frmSubmit:"campaign-submit",campaignWrapper:".c-campaign-wrapper",listOfCofFormType:["campaign-submit","campaign-temporary-data-storage","campaign-new-users-only","campaign-participation-check","campaign-restrict-access"],getUserDataFormList:["campaign-new-users-only","campaign-participation-check","campaign-restrict-access"]},initCampaign:function(){var a=this;a.parentCampaignStoreId=a.getCampaignLocalStore(),a.parentCampaignId=a.getCampaignId(),a.campaignSubmitHandler(),i.listenEvent("cof:next",function(e,t){a.preloadLocalstore()}),i.listenEvent("cof:qna:survey",function(e,t){a.trackCampaignSurveyLoad(e,t)}),i.listenEvent("cof:qna:quiz",function(e,t){a.trackCampaignSurveyLoad(e,t)}),i.listenEvent("cof:restart",function(e,t){a._resetCaptcha()}),i.listenEvent("cof:wrapper:previous",function(e,t){a._removeProfileIdFromLocalStorage(e,t,a)}),i.listenEvent("cof:wrapper:prev",function(e,t){a._qnaPrevHandler(e,t,a)}),i.listenEvent("cof:campaign:restrict:show",function(e,t){}),a.populateCampaignId(),a.initCampaignDone=!0},campaignSubmitHandler:function(){var r=this,n=r.$form.find('button[type="submit"]'),s=r.modelData.formType;0<n.length&&(s===r.settings.frmTypeParticipation||s===r.settings.frmNewUserOnly||s===r.settings.frmRestrictAccess||s===r.settings.frmSubmit)&&(r._successHandler=function(e,t,a){i.dispatchEvent("cof:loader:hide",r),n.removeAttr("disabled"),r.onFormSubmitTracking(e),r._resetCaptcha(),200===e.code?(0<=_.indexOf(r.settings.getUserDataFormList,r.modelData.formType)&&r.customizeSurvey(e.responseData),r.setFormResponse(e),r.trackCampaignSamples(r),i.dispatchEvent("cof:next",r),i.sendRevisitCall()):1503===e.code?i.dispatchEvent("cof:expire",r):s===r.settings.frmTypeParticipation?400===e.code?r._renderServerSideErrorMessages(r.modelData.failureMessage):r._handleErrorCodes(e):s===r.settings.frmNewUserOnly?1502===e.code?r._renderServerSideErrorMessages(r.modelData.userIsAlreadySignedupMessage):400===e.code?r._renderServerSideErrorMessages(r.modelData.failureMessage):r._handleErrorCodes(e):s===r.settings.frmRestrictAccess?1501===e.code?r._renderServerSideErrorMessages(r.modelData.accessDeniedMessage):400===e.code?r._renderServerSideErrorMessages(r.modelData.failureMessage):r._handleErrorCodes(e):r._handleErrorCodes(e)})},getCampaignLocalStore:function(){var e=this.$el.parents('[data-role="campaign-wrapper"]');return e?e.find(this.settings.campaignWrapper).attr("data-storagename"):""},getCampaignId:function(){var e=this.$el.parents('[data-role="campaign-wrapper"]');return e?e.find(this.settings.campaignWrapper).attr("data-ccid"):""},campaignLocalHandler:function(e,t){""!==e.parentCampaignStoreId&&e.setCofLocalStorage(e,t),i.dispatchEvent("cof:next",e)},setFormResponse:function(e){var t=this;t.modelData.formType!==t.settings.frmSubmit&&i.setLocalStorageItem("campaign-user-response-"+t.parentCampaignId,JSON.stringify(e)),e.responseData&&e.responseData.profileId&&t.setCofLocalStorage(t,{profileId:e.responseData.profileId})},setCofLocalStorage:function(e,t){var a=e.parentCampaignStoreId,r=JSON.parse(i.getLocalStorageItem(a)||"{}"),t=t||JSON.parse(e.getCurrentFormData());e.$el.find('input[name="g-recaptcha-type"]').length||void 0===r.g||delete r.g,t.surveyResponseList&&(e=e.mergeSurveyData(r,t),t.surveyResponseList[0].questionAnswersList=e),e=$.extend(!0,{},r,t),i.setLocalStorageItem(a,JSON.stringify(e))},preloadLocalstore:function(){var e=this,t=JSON.parse(i.getLocalStorageItem(e.parentCampaignStoreId));e.$form.attr("data-form-type")===e.settings.frmTypeLocal&&t&&void 0!==t.responseData&&null!==t.responseData&&e._allowEditingOfSavedData(t.responseData)},checkCampaignCookie:function(e){var t=i.getCookie(this.parentCampaignStoreId),a=!0,e=i.trimString(e),r=window.btoa(e);return""!==e&&(r===t?a=!1:i._createCookie(this.parentCampaignStoreId+"-start",r)),a},setCofCookieParticipation:function(e){var t=i.getCookie(e.parentCampaignStoreId+"-start");e.modelData.formType===e.settings.frmSubmit&&""!==t&&(i._createCookie(e.parentCampaignStoreId,t),i.eraseCookie(e.parentCampaignStoreId+"-start"))},alreadyParticipatedHandler:function(){this._renderServerSideErrorMessages(this.modelData.userAlreadyParticipatedMessage)},populateCampaignId:function(){var e=this.$el.parents(this.settings.campaignWrapper).attr("data-ccid");e&&$('form input[name="campaignId"]').val(e)},getCampaignSubmitData:function(e){var t=JSON.parse(i.getLocalStorageItem(this.parentCampaignStoreId)||"{}"),e=e?JSON.parse(e):"",e=$.extend(!0,{},t,e);return e.surveyResponseList&&t.surveyResponseList&&(e.surveyResponseList[0].questionAnswersList=t.surveyResponseList[0].questionAnswersList),JSON.stringify(e)},mergeSurveyData:function(e,t){return e.surveyResponseList?e.surveyResponseList[0].questionAnswersList.concat(t.surveyResponseList[0].questionAnswersList):t.surveyResponseList[0].questionAnswersList},customizeSurvey:function(e){var a,r,e=e.surveyResponseList?e.surveyResponseList[0].questionAnswersList:[],n=[],t=this.$el.parents('[data-role="campaign-wrapper"]'),t=t?t.find(this.settings.campaignQuestionAndAnswersSection):[];$.each(e,function(e,t){n.push(t.id)}),$.each(t,function(e,t){r=$(t).find(".js-question"),(a=r.attr("data-survey-que-id"))&&-1!==_.indexOf(n,a)?r.addClass("js-valid-qid"):$(t).remove()})},resetMsgBeforeSubmit:function(){this.$el.find(".form-error-msg").remove(),this.$el.find(".form-input-error").removeClass("form-input-error")},getCurrentFormData:function(){var e=t.formToJson(this.$form);return this.$form.find(this.settings.campaignQuestionAndAnswersSection).length&&(e=this.cofSurveyData(e)),e=i.getQueryStringVal("ulidh")?this._addUlidHashcodeData(e):e},_qnaPrevHandler:function(e,t,a){var t=$(t.ref[0]),r=a.parentCampaignStoreId,t=t.find(".c-que"),n=JSON.parse(i.getLocalStorageItem(a.parentCampaignStoreId)||"{}"),s=n.surveyResponseList?n.surveyResponseList[0].questionAnswersList:[];t.length&&s.length&&(t.each(function(e,t){for(var a=0;a<s.length;a++)s[a].id===$(t).data("survey-que-id").toString()&&s.splice(a,1)}),a.cofSurveyResponseDataPrev=s,(n.surveyResponseList[0].questionAnswersList=s).length||delete n.surveyResponseList,i.setLocalStorageItem(r,JSON.stringify(n)))},_removeProfileIdFromLocalStorage:function(e,t,a){var t=$(t.ref[0]).find('[name="formType"]').val(),r=JSON.parse(i.getLocalStorageItem(a.parentCampaignStoreId)||"{}");t===a.settings.frmNewUserOnly&&r.profileId&&(delete r.profileId,i.setLocalStorageItem(a.parentCampaignStoreId,JSON.stringify(r)))},_addUtmCampaign:function(e){return JSON.stringify($.extend(!0,{},JSON.parse(e),JSON.parse(i.getLocalStorageItem("utm-"+this.parentCampaignId)||"{}")))},trackCampaignSurveyLoad:function(e,t){t=$(t.ref[0]).parents(this.settings.campaignWrapper);t.length&&!t.attr("data-qna-track")&&(t.attr("data-qna-track",!0),this._trackCampaignSurveyStart())},trackCampaignSamples:function(e){e.$el.find(".c-samples").length&&e.trackRequestSample()}}),e});
define(["commonService","ecommerceCheckoutService"],function(){"use strict";var a,n=null;function e(){n=new IEA.commonService,a=new IEA.EcommerceCheckout}return _.extend(e.prototype,{_successRedirectUrl:function(e,s){IEA.History.started?Router.navigate(s,{trigger:!0}):(window.location.href=s,$(this.settings.checkoutFormV2).length&&this.checkoutFormSuccessHandler(e))},_loginRedirects:function(e,s){var t=n.getLocalStorageItem("returnUrl"),o=parseInt(e.UserRegistrationStatus,10);n.removeLocalStorageItem("sign-up-progressive_"+this.modelData.locale.trim()),2===o?""!==t&&null!==t?(n.removeLocalStorageItem("returnUrl"),window.location.href=t):s&&this._successRedirectUrl(e,s):1===o&&(window.location.href=$("input[name=register-redirect-url]").val())},_sendDataToLoginPopup:function(e,s){var t,o,r="secure-frame-login";if((window.name===r||$(this.settings.loginPage).length||$(this.settings.loginPageWrapper).length)&&this._trackSignIn(e),window.name===r)return t=window.location.hostname,o=e.UserRegistrationStatus,"https:"===location.protocol&&require(["postmessage"],function(){$.postMessage({resHeader:o},"http://"+t,parent)}),void(o&&(this.isLoginForm=!0));e.UserRegistrationStatus&&(this._loginRedirects(e,s),this.triggerMethod("success",this),this.isLoginForm=!0)},_renderSuccessMessage:function(e){var s=this,e=$('<div class="form-success-msg"><span class="success-msg-text">'+e+"</span></div>"),t=$(".global-navigation .o-navbar"),o=$(".c-secondary-nav"),r=0,i="uim_change_password"!==s.formType?e.offset().top-r:0,r=t.height()+o.height();$(s.settings.formErrorMsg).remove(),s.$form.before(e),"uim_update_profile"===s.formType||"uim_change_password"===s.formType?setTimeout(function(){s.$form.siblings(".form-success-msg").addClass("hidden")},7e3):s.$form.hide(),$("html, body").animate({scrollTop:i},500),n.getLocalStorageItem("isFormV2SuccessMessage")&&n.removeLocalStorageItem("isFormV2SuccessMessage")},_successHandlerMethod:function(e){var s,t,o=this,r=this.form.successRedirectURL,i=n.getLocalStorageItem("returnUrl");o.isLoginForm=!1,o.$form.find("button[type=submit]").prop("disabled",!1),e&&("delivery-address"!==o.compJson.formType||200!==e.code&&201!==e.code||(s={shippingAddress:e.responseData.shippingAddress,contact:e.responseData.contact,email:e.responseData.email,optIn:e.responseData.optIn},a.setEcommerceSignUpSession(s),o._trackShippingAddressSubmission(e.responseData)),o._sendDataToLoginPopup(e,r),o._hasBodyClass(o.settings.loginPageWrapper)&&o._sendQuickpollDiagnosticToolData(),200===e.code||201===e.code?(o._trackFormCheckboxes(e),o.onFormSubmitTracking(e),n.sendRevisitCall(),o._hasBodyClass(o.settings.loginPageWrapper)||void 0!==o.tokenCookie||"delivery-address"===o.compJson.formType||o.formType.startsWith("uim_")||o._createCookieOnFormSubmit(),"community_signup"===o.formType&&(s=document.body.getAttribute("data-locale"),t=document.querySelector(".en-flexible").getAttribute("data-community-locale"),e.unileverId&&"cookie"===e.unileverId.type&&(e.responseData.unileverId&&n.createCookie("UnileverId",e.responseData.unileverId,e.unileverId.ttl),e.cmId&&n.createCookie("_cmId"+("true"===t?"_"+s:""),e.cmId,e.unileverId.ttl)),n.setLocalStorageItem("communityUserDetails_"+s,JSON.stringify(e.responseData))),"delivery-address"===o.compJson.formType&&o.settings.isEcommerceUnifiedTemplate?(a.initUnifiedTemplate(),window.location.hash="step2",n.dispatchEvent("getDeliveryAddress",{})):o.modelData.convertToInstantWin?e&&e.responseData&&e.responseData.results&&e.responseData.results[0].Entry.Win&&("true"===e.responseData.results[0].Entry.Win.toLowerCase()?o.modelData.winRedirectPath?o._successRedirectUrl(e,o.modelData.winRedirectPath):o._renderSuccessMessage(o.modelData.instantWinMessage):o.modelData.loseRedirectPath?o._successRedirectUrl(e,o.modelData.loseRedirectPath):o._renderSuccessMessage(o.modelData.instantLoseMessage)):"uim_update_profile"===o.formType?o._renderSuccessMessage(o.modelData.updateProfileSuccessMsg):i&&"community_signup"===o.formType?(n.removeLocalStorageItem("returnUrl"),window.location.href=i):r?o._successRedirectUrl(e,r):o._renderSuccessMessage(this.form.successMessage),e.responseData&&e.responseData.results&&(digitalData.trackingInfo.un=e.responseData.results[0].udmdID),!r&&$(o.settings.loginRegisterV2Comp).length&&(n.setLocalStorageItem("isFormV2SuccessMessage","yes"),n.dispatchEvent("refreshHeader",o)),this.$form.find(".c-coupon-code").length&&this._trackRedeemCoupon(e),n.dispatchEvent("formSubmitted",o),"uim_update_profile"!==o.formType&&(o.isSubmitted=!0)):o.isLoginForm||(o._errorHandler(e),o.isSubmitted=!1)),this.triggerMethod("afterSuccess",e)},_handleCompetitionStatus:function(e){e?this._renderSuccessMessage(this.form.messageCompetitionWin):this._renderSuccessMessage(this.form.messageCompetitionLose)}}),e});
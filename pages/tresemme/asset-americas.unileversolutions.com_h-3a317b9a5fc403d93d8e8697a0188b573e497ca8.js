define(["typeahead"],function(){"use strict";var o;IEA.service("search",function(e,t,n){function a(){return this}return _.extend(a.prototype,{initialize:function(e){return this.options=_.extend({},e),this},trimString:function(e){return void 0===e?"":(e+"").replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},showSuggestions:function(u,t){var r,o=this,l=u.dropDownLabel,c=$(u.searchWrapper).attr("data-keyword"),n={templateSuggestions:"partials/input-suggestions.hbss",selectCallback:function(){}},d=t.getModelJSON(),p=void 0!==d.searchListingV2?d.searchListingV2:{},e=void 0===p.additionalBrands?[]:p.additionalBrands,h=[];e&&_.each(e,function(e){h.push(e.name)}),u=$.extend(n,u),$(u.searchInputField).typeahead({hint:u.hint||!1,highlight:!0,minLength:u.minLengthToTriggerAutoSuggest||3},{name:"keywordSearch",limit:"Infinity",beforeSelectedVal:this.query,source:function(e,t,a){var n,i,s;u.autoSuggest&&(n=u.queryParams||"&Locale="+u.locale+"&BrandName="+u.brandName+"&ab="+h.join(","),i=u.isExternal,r=u.groupCall?u.servletUrl+u.groupQueryParams:c+"?q="+encodeURIComponent(e)+n,u.skipSuggestions&&d.searchListing&&d.searchListing.tabContentTypes&&d.searchListing.tabContentTypes.length&&(s=(e=d.searchListing).tabContentTypes.findIndex(function(e){return"FAQ"===e.contentType}),r=r+"&SU="+e.currentPage+"&"+e.tabContentTypes[s].queryParams),u.skipSuggestions&&p&&p.tabContentTypes&&p.tabContentTypes.length&&(s=p.tabContentTypes.findIndex(function(e){return"FAQ"===e.contentType}),r=r+"&SU="+p.currentPage+"&"+p.tabContentTypes[s].queryParams),$.ajax(r,{beforeSend:function(e){i&&e.setRequestHeader("external-contents","recipe")},success:function(e,t){if(u.skipSuggestions){if(!e.totalResults)return!1;o.tempResponseData=e;var n=[];e.response.forEach(function(e){n.push(e.Title)}),e=n}u.groupCall&&(u.groupCall=!1,$(".c-address-lookup .tt-menu").show()),$.isArray(e)?a(e):0<e.totalResults?a(e.response):e.responseData&&e.responseData.result&&a(e.responseData.result)}}))},templates:{suggestion:function(e){return t.getTemplate("input-suggestions",n.templateSuggestions)({data:e,suggestionImage:u.suggestionImage,formAddressEnabled:u.formAddressEnabled,breakpointVariation:p.breakpointVariation})}}},{name:"keywordSearchDefault",limit:u.suggestionsLimitDefault||4,source:function(n,e,t){if(u.customKeyword&&(l||u.tabContentTypes)){var a,i,s=[],r=u.tabContentTypes||l;if(u.suggestContentTypes&&(c=!1,u.tabContentTypes&&u.tabContentTypes.length&&u.tabContentTypes.forEach(function(e){c=c||-1<n.indexOf(e.contentType)}),i=c),a=i||-1!==n.indexOf(l.inFAQ)||-1!==n.indexOf(l.inArticles)||-1!==n.indexOf(l.inProducts)||-1!==n.indexOf(l.inEverything)?n.split(" ")[0]:n,r.length&&!u.skipSuggestions)$(r).each(function(e,t){t=(u.inLabel||l)+" "+t.contentType;-1===n.indexOf(t)&&s.push(n+" "+t)});else if(!u.skipSuggestions)for(var o in l)o&&s.push(a+" "+l[o]);e(s)}var c}}).on("keydown",function(e){var t,n,a=e.key.toLowerCase(),i=$(this);"tab"!==a&&"arrowright"!==a||(n=i.typeahead("val"),n=o.isJSON(n)?JSON.parse(n):n,i.typeahead("val",n.Description||n),"tab"!==a||e.shiftKey||(i.typeahead("close"),(t=$(".c-search-listing-v2 .o-btn-clear-search")).is(":visible")&&setTimeout(function(){t.focus()},100)))}).on("keyup",function(e){var t=$(this),n=e.key.toLowerCase();t.typeahead("val")&&!t.typeahead("val").match(/^\s*$/)?$(u.clearSearch).removeClass("hidden"):$(u.clearSearch).addClass("hidden"),u.keyupCallback&&"enter"===n&&u.keyupCallback(u,e,t.val()),o.shrinkToFill(t.next("pre"),u.inputFont,t)}).bind("typeahead:cursorchange ",function(e,t){var n=$(this);t&&t.Title?n.val(t.Title):t&&t.Description&&n.val(t.Description)}).bind("typeahead:beforeselect ",function(e,t){u.typedVal=o.trimString($(this).val())}).bind("typeahead:selected",function(e,t,n){var a=$(this),i=a.val();try{u.searchKeyword=JSON.parse(i).Text}catch(e){u.searchKeyword=i}u.skipSuggestions&&o.tempResponseData.response.length&&o.tempResponseData.response.every(function(e,t){return!(0<=e.Title.search(i))||(e=o.tempResponseData.response[t].PageUrl.split("#"),i=e[e.length-1],!1)}),u.selectCallback(u,i,a),u.groupCall||(a.typeahead("close"),a.next("pre").text(u.searchKeyword),a.typeahead("val",u.searchKeyword+" "),a.val(u.searchKeyword),o.shrinkToFill(a.next("pre"),u.inputFont,a))}).bind("typeahead:render",function(e,t){var n=$(this),a=n.val().toLowerCase(),n=n.parent(),i=n.find(".tt-dataset-keywordSearch .tt-suggestion"),s=n.find(".tt-hint");s.hide(),i&&u.hint&&i.each(function(e,t){var n,t=t.innerText.toLowerCase();if(void 0!==u.tabContentTypes?n=u.tabContentTypes[e]:l?$.each(l,function(e,t){n=l[e].contentType}):n="",0===t.indexOf(a)&&-1===t.indexOf(n))return t.length===a.length&&s.val(""),s.show(),!1})})},isJSON:function(e){try{JSON.parse(e)}catch(e){return!1}return!0},measureText:function(e,t){e=$(e);return e.length&&e.css("font-size",t),{width:e.width(),height:e.height()}},shrinkToFill:function(e,t,n){var n=$(n),a=n.width()+5,e=this.measureText(e,t).width;n.css("font-size",(t=a<e?t*a/e*".95":t)+"px")},clearSearchVal:function(e){var t=e.data.field||".c-global-search__form .typeahead",n=e.data.wrapper||"",n=""!==n?$(e.target).parents(n).find(t):$(t);e.preventDefault(),n.typeahead("close"),n.val("").typeahead("val","").focus(),n.next("pre").text(""),$(this).addClass("hidden")},setPageTitle:function(e,t){t=t&&t.tagTitle?t.tagTitle:e;t&&(0<=(e=document.title).indexOf("|")?document.title=t+" | "+e.split("|")[1]:document.title=t+" | "+e)},initializeBarcodeApi:function(){return new Promise(function(a,e){function t(){var e,t="https://unpkg.com/@zxing/library@latest",n=0;$('script[src*="'+t+'"]').length?o?o.isMediaDevicesSuported?a(!0):a(!1):e=setInterval(function(){n++,o&&(clearInterval(e),o.isMediaDevicesSuported?a(!0):a(!1)),10<=n&&(clearInterval(e),a(!1))},100):require([t],function(e){e&&(o=new e.BrowserBarcodeReader).isMediaDevicesSuported?a(!0):a(!1)})}"complete"===document.readyState?t():window.addEventListener("load",t)})},getVideoDevices:function(){return new Promise(function(t,e){o&&"object"==typeof o&&o.getVideoInputDevices().then(function(e){t(e)})})},scanCode:function(s,r){return new Promise(function(t,n){var e,a,i;o&&"object"==typeof o&&(a=0,(e=o).decodeOnceFromVideoDevice(s,r).then(function(e){t(e)}).catch(function(e){clearInterval(i),o.reset(),n(e)}),i=setInterval(function(){e.stream?($(document).trigger("barcodeCameraAllowed",[{ref:e}]),clearInterval(i)):60<++a&&clearInterval(i)},1e3))})},closeScanner:function(){o&&"object"==typeof o&&o.reset()}}),a})});